package com.offtime.app.ui.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import android.content.Context
import dagger.hilt.android.qualifiers.ApplicationContext
import com.offtime.app.data.dao.AppCategoryDao
import com.offtime.app.data.dao.AppSessionUserDao
import com.offtime.app.data.dao.TimerSessionUserDao
import com.offtime.app.data.dao.DailyUsageDao
import com.offtime.app.data.dao.SummaryUsageDao
import com.offtime.app.data.dao.RewardPunishmentData
import com.offtime.app.data.dao.UsageData
import com.offtime.app.data.entity.AppCategoryEntity
import com.offtime.app.data.entity.AppSessionUserEntity
import com.offtime.app.utils.DataMigrationHelper
import javax.inject.Inject
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale
import java.util.Calendar
import com.offtime.app.data.dao.AppInfoDao
import com.offtime.app.data.dao.GoalRewardPunishmentUserDao
import com.offtime.app.data.dao.RewardPunishmentUserDao
import com.offtime.app.data.dao.RewardPunishmentWeekUserDao
import com.offtime.app.data.dao.RewardPunishmentMonthUserDao
import com.offtime.app.data.entity.RewardPunishmentUserEntity
import com.offtime.app.data.repository.AppRepository
import com.offtime.app.data.repository.AppSessionRepository
import com.offtime.app.data.repository.GoalRewardPunishmentRepository

@HiltViewModel
class HomeViewModel @Inject constructor(
    private val appRepository: AppRepository,
    private val appSessionRepository: AppSessionRepository,
    private val categoryDao: AppCategoryDao,
    private val appSessionUserDao: AppSessionUserDao,
    private val timerSessionUserDao: TimerSessionUserDao,
    private val dailyUsageDao: DailyUsageDao,
    private val summaryUsageDao: SummaryUsageDao,
    private val goalRewardPunishmentUserDao: GoalRewardPunishmentUserDao,
    private val rewardPunishmentUserDao: RewardPunishmentUserDao,
    private val rewardPunishmentWeekUserDao: RewardPunishmentWeekUserDao,
    private val rewardPunishmentMonthUserDao: RewardPunishmentMonthUserDao,
    private val dataMigrationHelper: DataMigrationHelper,
    @ApplicationContext private val context: Context,
    private val repository: GoalRewardPunishmentRepository
) : ViewModel() {

    companion object {
        // é…ç½®å¼€å…³ï¼šæ˜¯å¦å¯ç”¨å¯¹goals_reward_punishment_completionè¡¨çš„å¤‡ç”¨æŸ¥è¯¢
        // è®¾ä¸ºfalseå¯ä»¥å®Œå…¨ç¦ç”¨æ—§è¡¨æŸ¥è¯¢ï¼Œä»…ä½¿ç”¨reward_punishment_userè¡¨
        private const val ENABLE_FALLBACK_TO_OLD_TABLE = false
    }

    private val _categories = MutableStateFlow<List<AppCategoryEntity>>(emptyList())
    val categories: StateFlow<List<AppCategoryEntity>> = _categories.asStateFlow()

    private val _selectedCategory = MutableStateFlow<AppCategoryEntity?>(null)
    val selectedCategory: StateFlow<AppCategoryEntity?> = _selectedCategory.asStateFlow()

    private val _isStatisticsView = MutableStateFlow(true) // true=ä»Šæ—¥ç»Ÿè®¡, false=ä»Šæ—¥è¯¦æƒ…
    val isStatisticsView: StateFlow<Boolean> = _isStatisticsView.asStateFlow()

    // é¥¼å›¾æ•°æ®
    private val _realUsageSec = MutableStateFlow(0)
    val realUsageSec: StateFlow<Int> = _realUsageSec.asStateFlow()

    private val _virtualUsageSec = MutableStateFlow(0)
    val virtualUsageSec: StateFlow<Int> = _virtualUsageSec.asStateFlow()

    private val _goalSec = MutableStateFlow(7200) // é»˜è®¤2å°æ—¶
    val goalSec: StateFlow<Int> = _goalSec.asStateFlow()

    // å¥–åŠ±æƒ©ç½šç›¸å…³çŠ¶æ€
    private val _rewardText = MutableStateFlow("è–¯ç‰‡ä¸€åŒ…")
    val rewardText: StateFlow<String> = _rewardText.asStateFlow()
    
    private val _punishText = MutableStateFlow("ä¿¯å§æ’‘30ä¸ª")
    val punishText: StateFlow<String> = _punishText.asStateFlow()
    
    private val _goalConditionType = MutableStateFlow(0) // 0: â‰¤ç›®æ ‡ç®—å®Œæˆ(å¨±ä¹ç±»), 1: â‰¥ç›®æ ‡ç®—å®Œæˆ(å­¦ä¹ ç±»)
    val goalConditionType: StateFlow<Int> = _goalConditionType.asStateFlow()
    
    private val _yesterdayRewardDone = MutableStateFlow(true)
    val yesterdayRewardDone: StateFlow<Boolean> = _yesterdayRewardDone.asStateFlow()
    
    private val _yesterdayPunishDone = MutableStateFlow(true)
    val yesterdayPunishDone: StateFlow<Boolean> = _yesterdayPunishDone.asStateFlow()
    
    private val _yesterdayHasData = MutableStateFlow(false)
    val yesterdayHasData: StateFlow<Boolean> = _yesterdayHasData.asStateFlow()
    
    private val _yesterdayGoalMet = MutableStateFlow(false)
    val yesterdayGoalMet: StateFlow<Boolean> = _yesterdayGoalMet.asStateFlow()
    
    private val _isRewardPunishmentEnabled = MutableStateFlow(true)
    val isRewardPunishmentEnabled: StateFlow<Boolean> = _isRewardPunishmentEnabled.asStateFlow()

    // æŸ±çŠ¶å›¾æ•°æ® (24å°æ—¶ï¼Œæ¯å°æ—¶çš„åˆ†é’Ÿæ•°)
    private val _hourlyRealUsage = MutableStateFlow<List<Int>>(List(24) { 0 })
    val hourlyRealUsage: StateFlow<List<Int>> = _hourlyRealUsage.asStateFlow()

    private val _hourlyVirtualUsage = MutableStateFlow<List<Int>>(List(24) { 0 })
    val hourlyVirtualUsage: StateFlow<List<Int>> = _hourlyVirtualUsage.asStateFlow()
    
    // å‘¨æœŸé€‰æ‹©çŠ¶æ€ ("æ—¥", "å‘¨", "æœˆ") - ä¸ŠåŠéƒ¨åˆ†é¥¼å›¾ä½¿ç”¨
    private val _selectedPeriod = MutableStateFlow("æ—¥")
    val selectedPeriod: StateFlow<String> = _selectedPeriod.asStateFlow()
    
    // ä¸‹åŠéƒ¨åˆ†æŠ˜çº¿å›¾çš„å‘¨æœŸé€‰æ‹©çŠ¶æ€
    private val _selectedLineChartPeriod = MutableStateFlow("æ—¥")
    val selectedLineChartPeriod: StateFlow<String> = _selectedLineChartPeriod.asStateFlow()
    
    // æŠ˜çº¿å›¾æ•°æ®
    private val _usageLineData = MutableStateFlow<List<UsageData>>(emptyList())
    val usageLineData: StateFlow<List<UsageData>> = _usageLineData.asStateFlow()
    
    private val _completionLineData = MutableStateFlow<List<UsageData>>(emptyList())
    val completionLineData: StateFlow<List<UsageData>> = _completionLineData.asStateFlow()
    
    // å¥–ç½šå®Œæˆåº¦æ•°æ®
    private val _rewardPunishmentData = MutableStateFlow<List<RewardPunishmentData>>(emptyList())
    val rewardPunishmentData: StateFlow<List<RewardPunishmentData>> = _rewardPunishmentData.asStateFlow()
    
    // ç¼“å­˜æœºåˆ¶ - é¿å…é‡å¤æŸ¥è¯¢
    private var lastLoadedCategoryId: Int? = null
    private var lastLoadedPeriod: String? = null

    /**
     * è®¾ç½®è¿‡æ»¤åçš„å¥–ç½šæ•°æ®
     */
    private suspend fun setFilteredRewardPunishmentData(data: List<RewardPunishmentData>, categoryId: Int) {
        // æ£€æŸ¥è¯¥åˆ†ç±»çš„å¥–ç½šå¼€å…³æ˜¯å¦å¼€å¯
        val enabledMap = appRepository.getCategoryRewardPunishmentEnabled()
        val isEnabled = enabledMap[categoryId] ?: true // é»˜è®¤å¼€å¯
        
        if (isEnabled) {
            // å¼€å…³å¼€å¯æ—¶ï¼Œæ˜¾ç¤ºæ­£å¸¸æ•°æ®
            _rewardPunishmentData.value = data
        } else {
            // å¼€å…³å…³é—­æ—¶ï¼Œå°†æ•°æ®æ›¿æ¢ä¸º-1ï¼ˆè¡¨ç¤ºä¸æ˜¾ç¤ºï¼‰
            val filteredData = data.map { item ->
                item.copy(
                    rewardValue = -1f,
                    punishmentValue = -1f
                )
            }
            _rewardPunishmentData.value = filteredData
        }
        
        android.util.Log.d("HomeViewModel", "å¥–ç½šæ•°æ®è¿‡æ»¤: categoryId=$categoryId, enabled=$isEnabled, dataSize=${data.size}")
    }

    // å„åˆ†ç±»ä½¿ç”¨æ—¶é—´æ•°æ®ï¼ˆç”¨äºæ€»ä½¿ç”¨åˆ†ç±»çš„å¤šåˆ†ç±»æ˜¾ç¤ºï¼‰
    private val _categoryUsageData = MutableStateFlow<List<CategoryUsageItem>>(emptyList())
    val categoryUsageData: StateFlow<List<CategoryUsageItem>> = _categoryUsageData.asStateFlow()
    
    private val _categoryHourlyData = MutableStateFlow<List<CategoryHourlyItem>>(emptyList())
    val categoryHourlyData: StateFlow<List<CategoryHourlyItem>> = _categoryHourlyData.asStateFlow()
    
    init {
        loadInitialData()

    }

    fun loadInitialData() {
        loadCategories()
        // Load additional data as needed
    }

    fun loadCategories() {
        viewModelScope.launch {
            categoryDao.getAllCategories().collect { categoriesList ->
                // è·å–æ‰€æœ‰åˆ†ç±»ï¼ˆæ’é™¤ç»Ÿè®¡å·²ä»æ•°æ®åº“ä¸­åˆ é™¤ï¼‰
                val filteredCategories = categoriesList
                _categories.value = filteredCategories
                
                // ä½¿ç”¨é»˜è®¤æ˜¾ç¤ºç±»åˆ«æˆ–ç¬¬ä¸€ä¸ªåˆ†ç±»
                if (filteredCategories.isNotEmpty() && _selectedCategory.value == null) {
                    // æš‚æ—¶ä½¿ç”¨ç¬¬ä¸€ä¸ªåˆ†ç±»ä½œä¸ºé»˜è®¤ï¼Œåç»­ä¼šæ·»åŠ è®¾ç½®åŠŸèƒ½
                    selectCategory(filteredCategories.first())
                }
            }
        }
    }

    fun selectCategory(category: AppCategoryEntity) {
        // é¿å…é‡å¤é€‰æ‹©åŒä¸€ä¸ªåˆ†ç±»
        if (_selectedCategory.value?.id == category.id) {
            return
        }
        
        _selectedCategory.value = category
        // ä»æ•°æ®åº“æŸ¥è¯¢è¯¥åˆ†ç±»çš„ç›®æ ‡æ—¶é—´
        loadCategoryGoal(category.id)
        // åŠ è½½å¥–ç½šå¼€å…³çŠ¶æ€
        loadRewardPunishmentEnabled(category.id)
        // ç«‹å³åŠ è½½è¯¥åˆ†ç±»çš„æ•°æ®
        loadUsageData(category.id)
    }
    
    private fun loadCategoryGoal(categoryId: Int) {
        viewModelScope.launch {
            try {
                val goal = goalRewardPunishmentUserDao.getUserGoalByCatId(categoryId)
                if (goal != null) {
                    // å°†åˆ†é’Ÿè½¬æ¢ä¸ºç§’
                    _goalSec.value = goal.dailyGoalMin * 60
                    // åŠ è½½å¥–åŠ±æƒ©ç½šå†…å®¹
                    _rewardText.value = goal.rewardText
                    _punishText.value = goal.punishText
                    // è®¾ç½®ç›®æ ‡ç±»å‹
                    _goalConditionType.value = goal.conditionType
                    android.util.Log.d("HomeViewModel", "åˆ†ç±» $categoryId çš„ç›®æ ‡æ—¶é—´: ${goal.dailyGoalMin}åˆ†é’Ÿ = ${_goalSec.value}ç§’, ç±»å‹: ${goal.conditionType}, å¥–åŠ±: ${goal.rewardText}, æƒ©ç½š: ${goal.punishText}")
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›®æ ‡ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    _goalSec.value = 7200 // 2å°æ—¶
                    _rewardText.value = "è–¯ç‰‡ä¸€åŒ…"
                    _punishText.value = "ä¿¯å§æ’‘30ä¸ª"
                    _goalConditionType.value = 0 // é»˜è®¤ä¸ºå¨±ä¹ç±»
                    android.util.Log.w("HomeViewModel", "åˆ†ç±» $categoryId æ²¡æœ‰æ‰¾åˆ°ç›®æ ‡ï¼Œä½¿ç”¨é»˜è®¤å€¼2å°æ—¶ï¼Œç±»å‹0(å¨±ä¹ç±»)")
                }
            } catch (e: Exception) {
                android.util.Log.e("HomeViewModel", "æŸ¥è¯¢åˆ†ç±»ç›®æ ‡å¤±è´¥: ${e.message}", e)
                _goalSec.value = 7200 // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤å€¼
                _rewardText.value = "è–¯ç‰‡ä¸€åŒ…"
                _punishText.value = "ä¿¯å§æ’‘30ä¸ª"
                _goalConditionType.value = 0 // é»˜è®¤ä¸ºå¨±ä¹ç±»
            }
        }
    }

    private fun loadRewardPunishmentEnabled(categoryId: Int) {
        viewModelScope.launch {
            try {
                val enabledMap = appRepository.getCategoryRewardPunishmentEnabled()
                val isEnabled = enabledMap[categoryId] ?: true // é»˜è®¤å¼€å¯
                _isRewardPunishmentEnabled.value = isEnabled
                android.util.Log.d("HomeViewModel", "åˆ†ç±» $categoryId çš„å¥–ç½šå¼€å…³çŠ¶æ€: $isEnabled")
            } catch (e: Exception) {
                android.util.Log.e("HomeViewModel", "æŸ¥è¯¢åˆ†ç±»å¥–ç½šå¼€å…³çŠ¶æ€å¤±è´¥: ${e.message}", e)
                _isRewardPunishmentEnabled.value = true // å‡ºé”™æ—¶é»˜è®¤å¼€å¯
            }
        }
    }

    fun setStatisticsView(isStatistics: Boolean) {
        _isStatisticsView.value = isStatistics
    }
    
    fun setPeriod(period: String) {
        _selectedPeriod.value = period
        // ä¸ŠåŠéƒ¨åˆ†é¥¼å›¾çš„å‘¨æœŸæ”¹å˜ï¼Œè¿™é‡Œæš‚æ—¶ä¸é‡æ–°åŠ è½½æŠ˜çº¿å›¾æ•°æ®
        // æŠ˜çº¿å›¾æ•°æ®ç”±ä¸‹åŠéƒ¨åˆ†çš„å‘¨æœŸé€‰æ‹©å•ç‹¬æ§åˆ¶
    }
    
    fun setLineChartPeriod(period: String) {
        _selectedLineChartPeriod.value = period
        // é‡æ–°åŠ è½½æŠ˜çº¿å›¾æ•°æ®
        _selectedCategory.value?.let { category ->
            loadLineChartData(category.id, period)
        }
    }
    
    fun refreshData() {
        _selectedCategory.value?.let { category ->
            android.util.Log.d("HomeViewModel", "æ‰‹åŠ¨åˆ·æ–°æ•°æ®: é€‰ä¸­åˆ†ç±»=${category.name}, ID=${category.id}")
            loadUsageData(category.id)
            
            // æ›´æ–°é”å±å°éƒ¨ä»¶
            try {
                com.offtime.app.widget.WidgetUpdateManager.updateAllLockScreenWidgets(context)
            } catch (e: Exception) {
                android.util.Log.e("HomeViewModel", "æ›´æ–°é”å±å°éƒ¨ä»¶å¤±è´¥", e)
            }
        } ?: run {
            android.util.Log.e("HomeViewModel", "åˆ·æ–°æ•°æ®å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„åˆ†ç±»")
        }
    }
    
    // ä¸´æ—¶è°ƒè¯•æ–¹æ³•ï¼šç›´æ¥è®¾ç½®æµ‹è¯•æ•°æ®
    fun setTestData() {
        viewModelScope.launch {
            try {
                android.util.Log.d("HomeViewModel", "å¼€å§‹è®¾ç½®æµ‹è¯•æ•°æ®")
                
                // ä»æ•°æ®åº“è·å–æ‰€æœ‰æ•°æ®
                val allData = dailyUsageDao.getAllDailyUsageData()
                android.util.Log.d("HomeViewModel", "æ•°æ®åº“ä¸­æ€»å…±æœ‰ ${allData.size} æ¡è®°å½•")
                
                allData.forEach { data ->
                    android.util.Log.d("HomeViewModel", "è®°å½•: id=${data.id}, catId=${data.catId}, date=${data.date}, hour=${data.slotIndex}, isOffline=${data.isOffline}, duration=${data.durationSec}s")
                }
                
                val selectedCatId = _selectedCategory.value?.id ?: run {
            // åŠ¨æ€æŸ¥æ‰¾å¥èº«åˆ†ç±»IDï¼Œé¿å…ç¡¬ç¼–ç 
            val categories = _categories.value
            val fitnessCategory = categories.find { it.name == "å¥èº«" }
            fitnessCategory?.id ?: 3 // å¦‚æœæ‰¾ä¸åˆ°å¥èº«åˆ†ç±»ï¼Œä½¿ç”¨é»˜è®¤å€¼3
        }
                android.util.Log.d("HomeViewModel", "å½“å‰é€‰ä¸­åˆ†ç±»ID: $selectedCatId")
                
                // ç­›é€‰å½“å‰åˆ†ç±»çš„æ•°æ®
                val categoryData = allData.filter { it.catId == selectedCatId }
                android.util.Log.d("HomeViewModel", "åˆ†ç±» $selectedCatId çš„æ•°æ®æœ‰ ${categoryData.size} æ¡")
                
                if (categoryData.isNotEmpty()) {
                    val totalReal = categoryData.filter { it.isOffline == 0 }.sumOf { it.durationSec }
                    val totalVirtual = categoryData.filter { it.isOffline == 1 }.sumOf { it.durationSec }
                    
                    android.util.Log.d("HomeViewModel", "è®¡ç®—ç»“æœ: totalReal=${totalReal}s, totalVirtual=${totalVirtual}s")
                    
                    _realUsageSec.value = totalReal
                    _virtualUsageSec.value = totalVirtual
                    
                    android.util.Log.d("HomeViewModel", "å·²æ›´æ–°çŠ¶æ€: realUsageSec=${_realUsageSec.value}, virtualUsageSec=${_virtualUsageSec.value}")
                } else {
                    android.util.Log.w("HomeViewModel", "æ²¡æœ‰æ‰¾åˆ°åˆ†ç±» $selectedCatId çš„æ•°æ®")
                    _realUsageSec.value = 0
                    _virtualUsageSec.value = 0
                }
                
            } catch (e: Exception) {
                android.util.Log.e("HomeViewModel", "è®¾ç½®æµ‹è¯•æ•°æ®å¤±è´¥", e)
            }
        }
    }
    
    // ä¿®å¤åˆ†ç±»IDä¸åŒ¹é…é—®é¢˜ - ä½¿ç”¨æ–°çš„è¿ç§»æ¨¡å— + é‡æ–°èšåˆ
    fun fixCategoryIdMismatch() {
        viewModelScope.launch {
            try {
                android.util.Log.d("HomeViewModel", "ğŸ”§ å¼€å§‹å®Œæ•´çš„æ•°æ®ä¿®å¤æµç¨‹")
                
                // 1. æ£€æŸ¥æ˜¯å¦éœ€è¦è¿ç§»
                if (!dataMigrationHelper.needsMigration()) {
                    android.util.Log.d("HomeViewModel", "âœ… æ•°æ®å·²ç»æ­£ç¡®ï¼Œæ— éœ€è¿ç§»")
                    return@launch
                }
                
                android.util.Log.d("HomeViewModel", "âš ï¸ æ£€æµ‹åˆ°æ•°æ®é”™è¯¯ï¼Œå¼€å§‹ä¿®å¤...")
                
                // 2. åœæ­¢è‡ªåŠ¨èšåˆï¼ˆé¿å…åœ¨ä¿®å¤è¿‡ç¨‹ä¸­ç”Ÿæˆæ–°çš„é”™è¯¯æ•°æ®ï¼‰
                android.util.Log.d("HomeViewModel", "â¸ï¸ æš‚åœæ•°æ®èšåˆ...")
                
                // 3. æ‰§è¡Œæ•°æ®è¿ç§»
                android.util.Log.d("HomeViewModel", "ğŸ”„ å¼€å§‹æ•°æ®è¿ç§»...")
                val result = dataMigrationHelper.executeFullMigration()
                
                if (result.success) {
                    android.util.Log.d("HomeViewModel", "âœ… æ•°æ®è¿ç§»æˆåŠŸ!")
                    android.util.Log.d("HomeViewModel", "ğŸ“Š è¿ç§»ç»Ÿè®¡:")
                    android.util.Log.d("HomeViewModel", "  - daily_usage: ${result.dailyUsageMigrated} æ¡")
                    android.util.Log.d("HomeViewModel", "  - app_sessions: ${result.appSessionsMigrated} æ¡")
                    android.util.Log.d("HomeViewModel", "  - timer_sessions: ${result.timerSessionsMigrated} æ¡")
                    android.util.Log.d("HomeViewModel", "  - summary_usage: ${result.summaryUsageMigrated} æ¡")
                    android.util.Log.d("HomeViewModel", "  - æ€»è®¡: ${result.totalMigrated} æ¡")
                    
                    // 4. æ¸…ç†æ‰€æœ‰èšåˆæ•°æ®ï¼Œå‡†å¤‡é‡æ–°èšåˆ
                    android.util.Log.d("HomeViewModel", "ğŸ§¹ æ¸…ç†é”™è¯¯çš„èšåˆæ•°æ®...")
                    
                    // åˆ é™¤ä»Šå¤©çš„èšåˆæ•°æ®ï¼ˆdaily_usage_user å’Œ summary_usage_userï¼‰
                    val today = java.text.SimpleDateFormat("yyyy-MM-dd", java.util.Locale.getDefault()).format(java.util.Date())
                    
                    // åªåˆ é™¤é”™è¯¯IDçš„è®°å½•
                    try {
                        // æ¸…ç†é”™è¯¯çš„daily_usage_userè®°å½•ï¼ˆcatId=6çš„è®°å½•ï¼‰
                        val allDailyData = dailyUsageDao.getAllDailyUsageData()
                        val wrongDailyData = allDailyData.filter { it.catId == 6 && it.date == today }
                        android.util.Log.d("HomeViewModel", "å‘ç° ${wrongDailyData.size} æ¡é”™è¯¯çš„daily_usageè®°å½•éœ€è¦æ¸…ç†")
                        
                        // æ¸…ç†é”™è¯¯çš„summary_usageè®°å½•
                        val allSummaryData = summaryUsageDao.getAllSummaryUsageUser()
                        val wrongSummaryData = allSummaryData.filter { it.catId == 6 && it.date == today }
                        android.util.Log.d("HomeViewModel", "å‘ç° ${wrongSummaryData.size} æ¡é”™è¯¯çš„summary_usageè®°å½•éœ€è¦æ¸…ç†")
                        
                    } catch (e: Exception) {
                        android.util.Log.e("HomeViewModel", "æ¸…ç†èšåˆæ•°æ®æ—¶å‡ºé”™", e)
                    }
                    
                    // 5. è§¦å‘é‡æ–°èšåˆ
                    android.util.Log.d("HomeViewModel", "ğŸ”„ è§¦å‘æ•°æ®é‡æ–°èšåˆ...")
                    try {
                        val intent = android.content.Intent(context, com.offtime.app.service.DataAggregationService::class.java)
                        intent.action = com.offtime.app.service.DataAggregationService.ACTION_AGGREGATE_DATA
                        context.startService(intent)
                        android.util.Log.d("HomeViewModel", "âœ… æ•°æ®èšåˆæœåŠ¡å·²å¯åŠ¨")
                    } catch (e: Exception) {
                        android.util.Log.e("HomeViewModel", "å¯åŠ¨èšåˆæœåŠ¡å¤±è´¥", e)
                    }
                    
                    // 6. ç­‰å¾…èšåˆå®Œæˆï¼Œç„¶åé‡æ–°åŠ è½½æ•°æ®
                    kotlinx.coroutines.delay(3000) // ç­‰å¾…3ç§’è®©èšåˆå®Œæˆ
                    
                    android.util.Log.d("HomeViewModel", "ğŸ”„ é‡æ–°åŠ è½½UIæ•°æ®...")
                    loadCategories()
                    
                    // å¦‚æœå½“å‰é€‰æ‹©çš„æ˜¯å¥èº«åˆ†ç±»ï¼Œé‡æ–°åŠ è½½æ•°æ®
                    if (_selectedCategory.value?.name == "å¥èº«") {
                        categoryDao.getAllCategories().collect { categories ->
                            val fitnessCategory = categories.find { it.name == "å¥èº«" }
                            fitnessCategory?.let { 
                                loadUsageData(it.id)
                                android.util.Log.d("HomeViewModel", "âœ… å¥èº«åˆ†ç±»æ•°æ®å·²é‡æ–°åŠ è½½")
                            }
                        }
                    }
                    
                    android.util.Log.d("HomeViewModel", "ğŸ‰ æ•°æ®ä¿®å¤æµç¨‹å®Œæˆï¼")
                    
                } else {
                    android.util.Log.e("HomeViewModel", "âŒ æ•°æ®è¿ç§»å¤±è´¥: ${result.errorMessage}")
                }
                
            } catch (e: Exception) {
                android.util.Log.e("HomeViewModel", "âŒ ä¿®å¤è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸", e)
            }
        }
    }
    
    // æ˜¾ç¤ºè¿ç§»æŠ¥å‘Š
    fun showMigrationReport() {
        viewModelScope.launch {
            try {
                android.util.Log.d("HomeViewModel", "===== æ•°æ®è¿ç§»çŠ¶æ€æŠ¥å‘Š =====")
                
                val report = dataMigrationHelper.getMigrationReport()
                
                android.util.Log.d("HomeViewModel", "")
                android.util.Log.d("HomeViewModel", "=== åˆ†ç±»æ˜ å°„ ===")
                report.categoryMapping.forEach { (id, name) ->
                    android.util.Log.d("HomeViewModel", "ID=$id -> $name")
                }
                
                android.util.Log.d("HomeViewModel", "")
                android.util.Log.d("HomeViewModel", "=== å„è¡¨æ•°æ®åˆ†å¸ƒ ===")
                android.util.Log.d("HomeViewModel", "daily_usage_user:")
                report.dailyUsageByCategory.forEach { (catId, count) ->
                    val catName = report.categoryMapping[catId] ?: "æœªçŸ¥åˆ†ç±»"
                    android.util.Log.d("HomeViewModel", "  åˆ†ç±»ID=$catId ($catName): $count æ¡è®°å½•")
                }
                
                android.util.Log.d("HomeViewModel", "app_sessions_users:")
                report.appSessionsByCategory.forEach { (catId, count) ->
                    val catName = report.categoryMapping[catId] ?: "æœªçŸ¥åˆ†ç±»"
                    android.util.Log.d("HomeViewModel", "  åˆ†ç±»ID=$catId ($catName): $count æ¡è®°å½•")
                }
                
                android.util.Log.d("HomeViewModel", "timer_sessions_users:")
                report.timerSessionsByCategory.forEach { (catId, count) ->
                    val catName = report.categoryMapping[catId] ?: "æœªçŸ¥åˆ†ç±»"
                    android.util.Log.d("HomeViewModel", "  åˆ†ç±»ID=$catId ($catName): $count æ¡è®°å½•")
                }
                
                android.util.Log.d("HomeViewModel", "summary_usage_user:")
                report.summaryUsageByCategory.forEach { (catId, count) ->
                    val catName = report.categoryMapping[catId] ?: "æœªçŸ¥åˆ†ç±»"
                    android.util.Log.d("HomeViewModel", "  åˆ†ç±»ID=$catId ($catName): $count æ¡è®°å½•")
                }
                
                if (report.invalidCategoryIds.isNotEmpty()) {
                    android.util.Log.e("HomeViewModel", "")
                    android.util.Log.e("HomeViewModel", "âŒ å‘ç°æ— æ•ˆçš„åˆ†ç±»ID: ${report.invalidCategoryIds}")
                    android.util.Log.e("HomeViewModel", "è¿™äº›IDåœ¨AppCategory_Usersè¡¨ä¸­ä¸å­˜åœ¨ï¼Œéœ€è¦è¿ç§»ä¿®å¤")
                } else {
                    android.util.Log.d("HomeViewModel", "")
                    android.util.Log.d("HomeViewModel", "âœ… æ‰€æœ‰åˆ†ç±»IDéƒ½æœ‰æ•ˆ")
                }
                
                android.util.Log.d("HomeViewModel", "")
                android.util.Log.d("HomeViewModel", "===== æŠ¥å‘Šç»“æŸ =====")
                
            } catch (e: Exception) {
                android.util.Log.e("HomeViewModel", "ç”Ÿæˆè¿ç§»æŠ¥å‘Šå¤±è´¥", e)
            }
        }
    }
    

    
    fun loadUsageData(categoryId: Int) {
        viewModelScope.launch {
            val formatter = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
            val today = formatter.format(Date())
            
            val calendar = Calendar.getInstance()
            calendar.add(Calendar.DAY_OF_YEAR, -1)
            val yesterday = formatter.format(calendar.time)
            
            android.util.Log.d("HomeViewModel", "å¼€å§‹åŠ è½½ä½¿ç”¨æ•°æ®: categoryId=$categoryId, today=$today")
            
            // ç¡®ä¿åŠ è½½è¯¥åˆ†ç±»çš„ç›®æ ‡æ—¶é—´
            loadCategoryGoal(categoryId)
            
            // åŠ è½½ä»Šæ—¥ä½¿ç”¨æ•°æ®
            loadTodayUsageData(categoryId, today)
            
            // åŠ è½½æ˜¨æ—¥å¥–åŠ±æƒ©ç½šçŠ¶æ€ï¼ˆä¸´æ—¶ä½¿ç”¨å‡æ•°æ®ï¼‰
            loadYesterdayRewardPunishmentStatus(categoryId, yesterday)
            
            // åŠ è½½24å°æ—¶è¯¦æƒ…æ•°æ®
            loadHourlyUsageData(categoryId, today)
            
            // åŠ è½½æŠ˜çº¿å›¾æ•°æ® - ä½¿ç”¨ä¸‹åŠéƒ¨åˆ†çš„å‘¨æœŸé€‰æ‹©
            loadLineChartData(categoryId, _selectedLineChartPeriod.value)
        }
    }

    private suspend fun loadTodayUsageData(categoryId: Int, date: String) {
        try {
            android.util.Log.d("HomeViewModel", "æŸ¥è¯¢æŒ‡å®šæ—¥æœŸæ•°æ®: catId=$categoryId, date=$date")
            
            // æ£€æŸ¥æ˜¯å¦ä¸º"æ€»ä½¿ç”¨"åˆ†ç±»
            val category = categoryDao.getAllCategoriesList().find { it.id == categoryId }
            
            if (category?.name == "æ€»ä½¿ç”¨") {
                // æ€»ä½¿ç”¨åˆ†ç±»ï¼šä»èšåˆè¡¨è·å–æ•°æ®ï¼ˆå·²ç»æ˜¯æ±‡æ€»åçš„æ•°æ®ï¼‰
                android.util.Log.d("HomeViewModel", "åŠ è½½æ€»ä½¿ç”¨åˆ†ç±»æ•°æ®")
                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                
                _realUsageSec.value = realUsage
                _virtualUsageSec.value = virtualUsage
                
                // åŠ è½½å„åˆ†ç±»çš„è¯¦ç»†æ•°æ®ç”¨äºå¤šåˆ†ç±»æ˜¾ç¤º
                loadCategoryUsageData(date)
                
                android.util.Log.d("HomeViewModel", "æ€»ä½¿ç”¨åˆ†ç±»æ•°æ®: realUsage=${realUsage}s, virtualUsage=${virtualUsage}s")
            } else {
                // æ™®é€šåˆ†ç±»ï¼šç›´æ¥æŸ¥è¯¢æŒ‡å®šæ—¥æœŸçš„æ•°æ®
                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                
                _realUsageSec.value = realUsage
                _virtualUsageSec.value = virtualUsage
                
                android.util.Log.d("HomeViewModel", "æ™®é€šåˆ†ç±»æ•°æ®: realUsage=${realUsage}s, virtualUsage=${virtualUsage}s")
            }
            
            android.util.Log.d("HomeViewModel", "æœ€ç»ˆè®¾ç½®: realUsageSec=${_realUsageSec.value}, virtualUsageSec=${_virtualUsageSec.value}")
            
            // å¦‚æœå½“å¤©æ²¡æœ‰æ•°æ®ï¼Œè®°å½•æ—¥å¿—ä½†ä¸ä½¿ç”¨å†å²æ•°æ®
            if (_realUsageSec.value == 0 && _virtualUsageSec.value == 0) {
                android.util.Log.d("HomeViewModel", "æŒ‡å®šæ—¥æœŸ($date)æš‚æ— ä½¿ç”¨æ•°æ®ï¼Œè¿™æ˜¯æ­£å¸¸çš„")
            }
            
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "åŠ è½½æŒ‡å®šæ—¥æœŸæ•°æ®å¤±è´¥", e)
            // å‡ºé”™æ—¶è®¾ç½®ä¸º0ï¼Œä¸ä½¿ç”¨ç¤ºä¾‹æ•°æ®
            _realUsageSec.value = 0
            _virtualUsageSec.value = 0
        }
    }

    /**
     * åŠ è½½æ˜¨æ—¥å¥–ç½šçŠ¶æ€
     */
    private suspend fun loadYesterdayRewardPunishmentStatus(categoryId: Int, date: String) {
        try {
            android.util.Log.d("HomeViewModel", "æŸ¥è¯¢æ˜¨æ—¥å¥–ç½šçŠ¶æ€: categoryId=$categoryId, date=$date")
            
            // é¦–å…ˆç¡®ä¿æ˜¨å¤©çš„åŸºç¡€æ±‡æ€»è®°å½•å­˜åœ¨
            val summaryId = "${date}_${categoryId}"
            val summaryRecord = summaryUsageDao.getSummaryUsageById(summaryId)
            if (summaryRecord == null) {
                android.util.Log.w("HomeViewModel", "æ˜¨å¤©çš„æ±‡æ€»è®°å½•ä¸å­˜åœ¨ï¼Œå…ˆç”ŸæˆåŸºç¡€è®°å½•")
                // ç”ŸæˆåŸºç¡€è®°å½•
                com.offtime.app.service.DataAggregationService.ensureBaseRecords(context)
                // ç­‰å¾…ç”Ÿæˆå®Œæˆ
                kotlinx.coroutines.delay(1000)
            }
            
            // 1. ä¼˜å…ˆæŸ¥è¯¢å¥–æƒ©è®°å½•è¡¨ (reward_punishment_userè¡¨) - ä¸»è¦æ•°æ®æº
            val rewardPunishmentRecord = rewardPunishmentUserDao.getRecordByCategoryAndDate(categoryId, date)
            
            if (rewardPunishmentRecord != null) {
                // ä»å¥–æƒ©è®°å½•è¡¨æŸ¥è¯¢ï¼ˆä¸»è¦æ•°æ®æºï¼‰
                _yesterdayRewardDone.value = rewardPunishmentRecord.rewardDone == 1
                _yesterdayPunishDone.value = rewardPunishmentRecord.punishDone == 1
                _yesterdayGoalMet.value = rewardPunishmentRecord.isGoalMet == 1
                _yesterdayHasData.value = true // æœ‰æ•°æ®
                android.util.Log.d("HomeViewModel", "ä»å¥–æƒ©è®°å½•è¡¨æŸ¥è¯¢æ˜¨æ—¥å¥–ç½šçŠ¶æ€: reward=${rewardPunishmentRecord.rewardDone}, punishment=${rewardPunishmentRecord.punishDone}, goalMet=${rewardPunishmentRecord.isGoalMet}")
            } else {
                // 2. å¦‚æœæ–°è¡¨æ²¡æœ‰æ•°æ®ï¼Œéœ€è¦æ ¹æ®æ˜¨æ—¥ä½¿ç”¨æƒ…å†µè‡ªåŠ¨åˆ¤æ–­
                val yesterdayGoalResult = checkYesterdayGoalCompletion(categoryId, date)
                
                if (yesterdayGoalResult.hasData) {
                    // æœ‰ä½¿ç”¨æ•°æ®ï¼Œè‡ªåŠ¨ç”Ÿæˆå¥–æƒ©è®°å½•
                    autoGenerateYesterdayRewardPunishmentRecord(categoryId, date, yesterdayGoalResult.goalCompleted)
                    
                    // æ ¹æ®ç›®æ ‡å®Œæˆæƒ…å†µè®¾ç½®å¥–ç½šçŠ¶æ€
                    _yesterdayHasData.value = true // æœ‰æ•°æ®
                    _yesterdayGoalMet.value = yesterdayGoalResult.goalCompleted
                    if (yesterdayGoalResult.goalCompleted) {
                        // ç›®æ ‡å®Œæˆ -> æœ‰å¥–åŠ±ï¼Œæ— æƒ©ç½š
                        _yesterdayRewardDone.value = false  // å¥–åŠ±å¾…é¢†å–
                        _yesterdayPunishDone.value = true   // æ— æƒ©ç½šéœ€è¦æ‰§è¡Œï¼ˆä¸æ˜¾ç¤ºæƒ©ç½šæ¨¡å—ï¼‰
                    } else {
                        // ç›®æ ‡æœªå®Œæˆ -> æ— å¥–åŠ±ï¼Œæœ‰æƒ©ç½š
                        _yesterdayRewardDone.value = true   // æ— å¥–åŠ±å¯é¢†å–ï¼ˆä¸æ˜¾ç¤ºå¥–åŠ±æ¨¡å—ï¼‰
                        _yesterdayPunishDone.value = false  // æƒ©ç½šå¾…æ‰§è¡Œ
                    }
                    android.util.Log.d("HomeViewModel", "è‡ªåŠ¨ç”Ÿæˆæ˜¨æ—¥å¥–ç½šè®°å½•å¹¶è®¾ç½®çŠ¶æ€: goalCompleted=${yesterdayGoalResult.goalCompleted}, reward=${_yesterdayRewardDone.value}, punishment=${_yesterdayPunishDone.value}")
                    android.util.Log.d("HomeViewModel", "æœ€ç»ˆUIçŠ¶æ€: goalMet=${_yesterdayGoalMet.value}, rewardDone=${_yesterdayRewardDone.value}, punishDone=${_yesterdayPunishDone.value}")
                } else {
                    // æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œè®¾ç½®é»˜è®¤çŠ¶æ€
                    _yesterdayRewardDone.value = true   // é»˜è®¤å·²å¤„ç†
                    _yesterdayPunishDone.value = true   // é»˜è®¤å·²å¤„ç†
                    _yesterdayGoalMet.value = false     // é»˜è®¤æœªå®Œæˆç›®æ ‡
                    _yesterdayHasData.value = false     // æ ‡è®°æ˜¨æ—¥æ— æ•°æ®
                    android.util.Log.d("HomeViewModel", "æ˜¨æ—¥æ— æ•°æ®ï¼Œè®¾ç½®é»˜è®¤å¥–ç½šçŠ¶æ€: å…¨éƒ¨å·²å¤„ç†")
                }
            }
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "æŸ¥è¯¢æ˜¨æ—¥å¥–ç½šçŠ¶æ€å¤±è´¥", e)
            // å‡ºé”™æ—¶è®¾ç½®é»˜è®¤çŠ¶æ€
            _yesterdayRewardDone.value = true
            _yesterdayPunishDone.value = true
            _yesterdayGoalMet.value = false
        }
    }
    
    /**
     * è‡ªåŠ¨ç”Ÿæˆæ˜¨æ—¥å¥–æƒ©è®°å½•
     */
    private suspend fun autoGenerateYesterdayRewardPunishmentRecord(categoryId: Int, yesterday: String, goalCompleted: Boolean) {
        try {
            android.util.Log.d("HomeViewModel", "è‡ªåŠ¨ç”Ÿæˆæ˜¨æ—¥å¥–æƒ©è®°å½•: categoryId=$categoryId, date=$yesterday, goalCompleted=$goalCompleted")
            
            // åˆ›å»ºå¥–æƒ©è®°å½•
            val record = com.offtime.app.data.entity.RewardPunishmentUserEntity(
                id = "${yesterday}_$categoryId",
                date = yesterday,
                catId = categoryId,
                isGoalMet = if (goalCompleted) 1 else 0,
                rewardDone = 0, // åˆå§‹çŠ¶æ€ï¼šå¥–æƒ©éƒ½æœªæ‰§è¡Œ
                punishDone = 0,
                updateTime = System.currentTimeMillis()
            )
            
            // æ’å…¥è®°å½•
            rewardPunishmentUserDao.upsert(record)
            
            android.util.Log.d("HomeViewModel", "æ˜¨æ—¥å¥–æƒ©è®°å½•å·²è‡ªåŠ¨ç”Ÿæˆ")
            
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "è‡ªåŠ¨ç”Ÿæˆæ˜¨æ—¥å¥–æƒ©è®°å½•å¤±è´¥", e)
        }
    }
    
    /**
     * æ£€æŸ¥æ˜¨æ—¥ç›®æ ‡å®Œæˆæƒ…å†µ
     */
    private suspend fun checkYesterdayGoalCompletion(categoryId: Int, yesterday: String): YesterdayGoalResult {
        return try {
            // è·å–åˆ†ç±»ä¿¡æ¯
            val category = categoryDao.getCategoryById(categoryId)
            val categoryName = category?.name ?: "æœªçŸ¥åˆ†ç±»"
            
            // ç®€åŒ–çš„é€»è¾‘ï¼šç”±äºæ¯å¤©éƒ½æœ‰åŸºç¡€æ±‡æ€»è®°å½•ï¼Œç›´æ¥æ£€æŸ¥æ±‡æ€»è¡¨
            val summaryRecord = summaryUsageDao.getSummaryUsageById("${yesterday}_${categoryId}")
            
            if (summaryRecord != null) {
                // æœ‰æ±‡æ€»è®°å½•ï¼Œè¯´æ˜æœ‰æ•°æ®ï¼ˆå³ä½¿ä½¿ç”¨æ—¶é—´ä¸º0ï¼‰
                val totalUsageSeconds = summaryRecord.totalSec
            
            // è·å–ç›®æ ‡é…ç½®
            val goal = goalRewardPunishmentUserDao.getUserGoalByCatId(categoryId)
            
            if (goal != null) {
                    val goalSeconds = goal.dailyGoalMin * 60
                    val goalCompleted = when (goal.conditionType) {
                        0 -> totalUsageSeconds <= goalSeconds  // å¨±ä¹ç±»ï¼šä½¿ç”¨æ—¶é—´ â‰¤ ç›®æ ‡æ—¶é—´ç®—å®Œæˆ
                        1 -> totalUsageSeconds >= goalSeconds  // å­¦ä¹ ç±»ï¼šä½¿ç”¨æ—¶é—´ â‰¥ ç›®æ ‡æ—¶é—´ç®—å®Œæˆ
                        else -> false
                    }
                    
                    android.util.Log.d("HomeViewModel", "æ˜¨æ—¥ç›®æ ‡æ£€æŸ¥[$categoryName]: ä½¿ç”¨${totalUsageSeconds}s(${totalUsageSeconds/60}min), ç›®æ ‡${goalSeconds}s(${goal.dailyGoalMin}min), ç±»å‹${goal.conditionType}, å®Œæˆ$goalCompleted")
                    YesterdayGoalResult(hasData = true, goalCompleted = goalCompleted)
                } else {
                    // æœ‰æ•°æ®ä½†æ— ç›®æ ‡é…ç½®
                    android.util.Log.d("HomeViewModel", "æ˜¨æ—¥ç›®æ ‡æ£€æŸ¥[$categoryName]: æœ‰æ•°æ®ä½†æ— ç›®æ ‡é…ç½®")
                    YesterdayGoalResult(hasData = true, goalCompleted = false)
                }
            } else {
                // æ— æ±‡æ€»è®°å½•ï¼Œè¯´æ˜ç¨‹åºå®‰è£…å‰
                android.util.Log.d("HomeViewModel", "æ˜¨æ—¥ç›®æ ‡æ£€æŸ¥[$categoryName]: æ— æ±‡æ€»è®°å½•ï¼ˆç¨‹åºå®‰è£…å‰ï¼‰")
                YesterdayGoalResult(hasData = false, goalCompleted = false)
            }
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "æ£€æŸ¥æ˜¨æ—¥ç›®æ ‡å®Œæˆæƒ…å†µå¤±è´¥", e)
            YesterdayGoalResult(hasData = false, goalCompleted = false)
        }
    }
    
    /**
     * æ˜¨æ—¥ç›®æ ‡æ£€æŸ¥ç»“æœ
     */
    private data class YesterdayGoalResult(
        val hasData: Boolean,      // æ˜¯å¦æœ‰æ•°æ®
        val goalCompleted: Boolean // ç›®æ ‡æ˜¯å¦å®Œæˆ
    )
    
    /**
     * å„åˆ†ç±»ä½¿ç”¨æ—¶é—´æ•°æ®é¡¹ï¼ˆç”¨äºæ€»ä½¿ç”¨åˆ†ç±»çš„é¥¼å›¾æ˜¾ç¤ºï¼‰
     */
    data class CategoryUsageItem(
        val categoryId: Int,
        val categoryName: String,
        val realUsageSec: Int,
        val virtualUsageSec: Int,
        val color: androidx.compose.ui.graphics.Color
    )

    /**
     * å„åˆ†ç±»24å°æ—¶æ•°æ®é¡¹ï¼ˆç”¨äºæ€»ä½¿ç”¨åˆ†ç±»çš„æŸ±çŠ¶å›¾æ˜¾ç¤ºï¼‰
     */
    data class CategoryHourlyItem(
        val categoryId: Int,
        val categoryName: String,
        val hourlyRealUsage: List<Int>,  // 24å°æ—¶çœŸå®ä½¿ç”¨åˆ†é’Ÿæ•°
        val hourlyVirtualUsage: List<Int>, // 24å°æ—¶è™šæ‹Ÿä½¿ç”¨åˆ†é’Ÿæ•°
        val color: androidx.compose.ui.graphics.Color
    )

    /**
     * å®Œæˆæ˜¨æ—¥å¥–åŠ±
     */
    fun completeYesterdayReward() {
        viewModelScope.launch {
            try {
                val categoryId = _selectedCategory.value?.id ?: return@launch
                val yesterday = getYesterdayDate()
                
                android.util.Log.d("HomeViewModel", "å®Œæˆæ˜¨æ—¥å¥–åŠ±: categoryId=$categoryId, date=$yesterday")
                
                // æ›´æ–°reward_punishment_userè¡¨
                val existingRecord = rewardPunishmentUserDao.getRecordByCategoryAndDate(categoryId, yesterday)
                if (existingRecord != null) {
                    // æ›´æ–°ç°æœ‰è®°å½•çš„å¥–åŠ±å®ŒæˆçŠ¶æ€
                    rewardPunishmentUserDao.markRewardDone(categoryId, yesterday, 1)
                    android.util.Log.d("HomeViewModel", "å·²æ›´æ–°reward_punishment_userè¡¨çš„å¥–åŠ±çŠ¶æ€")
                } else {
                    android.util.Log.d("HomeViewModel", "reward_punishment_userè¡¨ä¸­æ²¡æœ‰å¯¹åº”è®°å½•ï¼Œè·³è¿‡æ›´æ–°")
                }
                
                // æ›´æ–°UIçŠ¶æ€
                _yesterdayRewardDone.value = true
                
                android.util.Log.d("HomeViewModel", "æ˜¨æ—¥å¥–åŠ±å·²å®Œæˆ")
                
            } catch (e: Exception) {
                android.util.Log.e("HomeViewModel", "å®Œæˆæ˜¨æ—¥å¥–åŠ±å¤±è´¥", e)
            }
        }
    }

    /**
     * å®Œæˆæ˜¨æ—¥æƒ©ç½š
     */
    fun completeYesterdayPunishment() {
        viewModelScope.launch {
            try {
                val categoryId = _selectedCategory.value?.id ?: return@launch
                val yesterday = getYesterdayDate()
                
                android.util.Log.d("HomeViewModel", "å®Œæˆæ˜¨æ—¥æƒ©ç½š: categoryId=$categoryId, date=$yesterday")
                
                // æ›´æ–°reward_punishment_userè¡¨
                val existingRecord = rewardPunishmentUserDao.getRecordByCategoryAndDate(categoryId, yesterday)
                if (existingRecord != null) {
                    // æ›´æ–°ç°æœ‰è®°å½•çš„æƒ©ç½šå®ŒæˆçŠ¶æ€
                    rewardPunishmentUserDao.markPunishmentDone(categoryId, yesterday, 1)
                    android.util.Log.d("HomeViewModel", "å·²æ›´æ–°reward_punishment_userè¡¨çš„æƒ©ç½šçŠ¶æ€")
                } else {
                    android.util.Log.d("HomeViewModel", "reward_punishment_userè¡¨ä¸­æ²¡æœ‰å¯¹åº”è®°å½•ï¼Œè·³è¿‡æ›´æ–°")
                }
                
                // æ›´æ–°UIçŠ¶æ€
                _yesterdayPunishDone.value = true
                
                android.util.Log.d("HomeViewModel", "æ˜¨æ—¥æƒ©ç½šå·²å®Œæˆ")
                
            } catch (e: Exception) {
                android.util.Log.e("HomeViewModel", "å®Œæˆæ˜¨æ—¥æƒ©ç½šå¤±è´¥", e)
            }
        }
    }

    /**
     * è·å–æ˜¨æ—¥æ—¥æœŸå­—ç¬¦ä¸²
     */
    private fun getYesterdayDate(): String {
        val calendar = Calendar.getInstance()
        calendar.add(Calendar.DAY_OF_YEAR, -1)
        return SimpleDateFormat("yyyy-MM-dd", Locale.getDefault()).format(calendar.time)
    }

    private suspend fun loadHourlyUsageData(categoryId: Int, date: String) {
        try {
            android.util.Log.d("HomeViewModel", "å¼€å§‹åŠ è½½24å°æ—¶æ•°æ®: categoryId=$categoryId, date=$date")
            
            // è·å–å½“å‰æ—¶é—´ï¼Œç”¨äºç¡®å®šåº”è¯¥æ˜¾ç¤ºåˆ°å“ªä¸ªå°æ—¶
            val currentTime = Calendar.getInstance()
            val currentHour = currentTime.get(Calendar.HOUR_OF_DAY)
            val today = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault()).format(Date())
            
            android.util.Log.d("HomeViewModel", "å½“å‰æ—¶é—´: ${currentTime.time}, å½“å‰å°æ—¶: $currentHour, ä»Šå¤©: $today")
            
            // æ£€æŸ¥æ˜¯å¦ä¸º"æ€»ä½¿ç”¨"åˆ†ç±»
            val category = categoryDao.getAllCategoriesList().find { it.id == categoryId }
            
            if (category?.name == "æ€»ä½¿ç”¨") {
                android.util.Log.d("HomeViewModel", "åŠ è½½æ€»ä½¿ç”¨åˆ†ç±»çš„24å°æ—¶æ•°æ®")
                // æ€»ä½¿ç”¨åˆ†ç±»ï¼šä»èšåˆè¡¨è·å–æ•°æ®ï¼ˆå·²ç»æ˜¯æ±‡æ€»åçš„æ•°æ®ï¼‰
                val realHourlyData = dailyUsageDao.getHourlyUsage(categoryId, date, 0)
                val virtualHourlyData = dailyUsageDao.getHourlyUsage(categoryId, date, 1)
                
                android.util.Log.d("HomeViewModel", "æ€»ä½¿ç”¨åˆ†ç±»æŸ¥è¯¢åˆ°çœŸå®å°æ—¶æ•°æ®: ${realHourlyData.size}æ¡, è™šæ‹Ÿå°æ—¶æ•°æ®: ${virtualHourlyData.size}æ¡")
                
                // æ„å»º24å°æ—¶æ•°æ®
                val realHourlyMinutes = mutableListOf<Int>()
                val virtualHourlyMinutes = mutableListOf<Int>()
                
                for (hour in 0..23) {
                    val realSeconds = realHourlyData.find { it.hour == hour }?.totalSeconds ?: 0
                    val virtualSeconds = virtualHourlyData.find { it.hour == hour }?.totalSeconds ?: 0
                    
                    // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºå½“å‰æ—¶é—´ä¹‹å‰çš„æ•°æ®
                    if (date == today && hour > currentHour) {
                        realHourlyMinutes.add(0)
                        virtualHourlyMinutes.add(0)
                    } else {
                        realHourlyMinutes.add(realSeconds / 60) // è½¬æ¢ä¸ºåˆ†é’Ÿ
                        virtualHourlyMinutes.add(virtualSeconds / 60)
                    }
                }
                
                _hourlyRealUsage.value = realHourlyMinutes
                _hourlyVirtualUsage.value = virtualHourlyMinutes
                
                // åŠ è½½å„åˆ†ç±»çš„24å°æ—¶è¯¦ç»†æ•°æ®ç”¨äºå¤šåˆ†ç±»æ˜¾ç¤º
                loadCategoryHourlyData(date, today, currentHour)
                
                android.util.Log.d("HomeViewModel", "æ€»ä½¿ç”¨åˆ†ç±»24å°æ—¶çœŸå®æ•°æ®(åˆ†é’Ÿ): $realHourlyMinutes")
                android.util.Log.d("HomeViewModel", "æ€»ä½¿ç”¨åˆ†ç±»24å°æ—¶è™šæ‹Ÿæ•°æ®(åˆ†é’Ÿ): $virtualHourlyMinutes")
            } else {
                // æ™®é€šåˆ†ç±»ï¼šæŸ¥è¯¢æŒ‡å®šæ—¥æœŸçš„æ•°æ®
                val realHourlyData = dailyUsageDao.getHourlyUsage(categoryId, date, 0)
                val virtualHourlyData = dailyUsageDao.getHourlyUsage(categoryId, date, 1)
                
                android.util.Log.d("HomeViewModel", "æ™®é€šåˆ†ç±»æŸ¥è¯¢åˆ°çœŸå®å°æ—¶æ•°æ®: ${realHourlyData.size}æ¡, è™šæ‹Ÿå°æ—¶æ•°æ®: ${virtualHourlyData.size}æ¡")
                
                // æ„å»º24å°æ—¶æ•°æ®
                val realHourlyMinutes = mutableListOf<Int>()
                val virtualHourlyMinutes = mutableListOf<Int>()
                
                for (hour in 0..23) {
                    val realSeconds = realHourlyData.find { it.hour == hour }?.totalSeconds ?: 0
                    val virtualSeconds = virtualHourlyData.find { it.hour == hour }?.totalSeconds ?: 0
                    
                    // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºå½“å‰æ—¶é—´ä¹‹å‰çš„æ•°æ®
                    if (date == today && hour > currentHour) {
                        realHourlyMinutes.add(0)
                        virtualHourlyMinutes.add(0)
                    } else {
                        realHourlyMinutes.add(realSeconds / 60) // è½¬æ¢ä¸ºåˆ†é’Ÿ
                        virtualHourlyMinutes.add(virtualSeconds / 60)
                    }
                }
                
                _hourlyRealUsage.value = realHourlyMinutes
                _hourlyVirtualUsage.value = virtualHourlyMinutes
                
                android.util.Log.d("HomeViewModel", "æ™®é€šåˆ†ç±»24å°æ—¶çœŸå®æ•°æ®(åˆ†é’Ÿ): $realHourlyMinutes")
                android.util.Log.d("HomeViewModel", "æ™®é€šåˆ†ç±»24å°æ—¶è™šæ‹Ÿæ•°æ®(åˆ†é’Ÿ): $virtualHourlyMinutes")
            }
            
            android.util.Log.d("HomeViewModel", "å½“å‰æ˜¯$currentHour ç‚¹ï¼Œæ‰€ä»¥$currentHour ç‚¹ä¹‹åçš„æ•°æ®éƒ½è®¾ç½®ä¸º0")
            
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "åŠ è½½24å°æ—¶æ•°æ®å¤±è´¥", e)
            // å‡ºé”™æ—¶ä½¿ç”¨å…¨0æ•°æ®
            _hourlyRealUsage.value = List(24) { 0 }
            _hourlyVirtualUsage.value = List(24) { 0 }
        }
    }
    
    /**
     * åŠ è½½å„åˆ†ç±»çš„ä½¿ç”¨æ—¶é—´æ•°æ®ï¼ˆç”¨äºæ€»ä½¿ç”¨åˆ†ç±»çš„é¥¼å›¾æ˜¾ç¤ºï¼‰
     */
    private suspend fun loadCategoryUsageData(date: String) {
        try {
            android.util.Log.d("HomeViewModel", "å¼€å§‹åŠ è½½å„åˆ†ç±»ä½¿ç”¨æ•°æ®ç”¨äºå¤šåˆ†ç±»æ˜¾ç¤º")
            
            val allCategories = categoryDao.getAllCategoriesList()
            val totalUsageCategory = allCategories.find { it.name == "æ€»ä½¿ç”¨" }
            
            // è¿‡æ»¤æ‰"æ€»ä½¿ç”¨"åˆ†ç±»æœ¬èº«
            val validCategories = allCategories.filter { 
                it.id != totalUsageCategory?.id 
            }
            
            val categoryUsageList = mutableListOf<CategoryUsageItem>()
            
            for (category in validCategories) {
                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(category.id, date, 0) ?: 0
                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(category.id, date, 1) ?: 0
                
                // åªæ·»åŠ æœ‰ä½¿ç”¨æ—¶é—´çš„åˆ†ç±»
                if (realUsage > 0 || virtualUsage > 0) {
                    val categoryColor = com.offtime.app.utils.CategoryUtils.getCategoryColor(category.name)
                    
                    categoryUsageList.add(CategoryUsageItem(
                        categoryId = category.id,
                        categoryName = category.name,
                        realUsageSec = realUsage,
                        virtualUsageSec = virtualUsage,
                        color = categoryColor
                    ))
                }
            }
            
            _categoryUsageData.value = categoryUsageList
            android.util.Log.d("HomeViewModel", "åŠ è½½äº†${categoryUsageList.size}ä¸ªåˆ†ç±»çš„ä½¿ç”¨æ•°æ®")
            
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "åŠ è½½å„åˆ†ç±»ä½¿ç”¨æ•°æ®å¤±è´¥", e)
            _categoryUsageData.value = emptyList()
        }
    }
    
    /**
     * åŠ è½½å„åˆ†ç±»çš„24å°æ—¶æ•°æ®ï¼ˆç”¨äºæ€»ä½¿ç”¨åˆ†ç±»çš„æŸ±çŠ¶å›¾æ˜¾ç¤ºï¼‰
     */
    private suspend fun loadCategoryHourlyData(date: String, today: String, currentHour: Int) {
        try {
            android.util.Log.d("HomeViewModel", "å¼€å§‹åŠ è½½å„åˆ†ç±»24å°æ—¶æ•°æ®ç”¨äºå¤šåˆ†ç±»æ˜¾ç¤º")
            
            val allCategories = categoryDao.getAllCategoriesList()
            val totalUsageCategory = allCategories.find { it.name == "æ€»ä½¿ç”¨" }
            
            // è¿‡æ»¤æ‰"æ€»ä½¿ç”¨"åˆ†ç±»æœ¬èº«
            val validCategories = allCategories.filter { 
                it.id != totalUsageCategory?.id 
            }
            
            val categoryHourlyList = mutableListOf<CategoryHourlyItem>()
            
            for (category in validCategories) {
                val realHourlyData = dailyUsageDao.getHourlyUsage(category.id, date, 0)
                val virtualHourlyData = dailyUsageDao.getHourlyUsage(category.id, date, 1)
                
                // æ„å»º24å°æ—¶æ•°æ®
                val realHourlyMinutes = mutableListOf<Int>()
                val virtualHourlyMinutes = mutableListOf<Int>()
                
                for (hour in 0..23) {
                    val realSeconds = realHourlyData.find { it.hour == hour }?.totalSeconds ?: 0
                    val virtualSeconds = virtualHourlyData.find { it.hour == hour }?.totalSeconds ?: 0
                    
                    // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºå½“å‰æ—¶é—´ä¹‹å‰çš„æ•°æ®
                    if (date == today && hour > currentHour) {
                        realHourlyMinutes.add(0)
                        virtualHourlyMinutes.add(0)
                    } else {
                        realHourlyMinutes.add(realSeconds / 60) // è½¬æ¢ä¸ºåˆ†é’Ÿ
                        virtualHourlyMinutes.add(virtualSeconds / 60)
                    }
                }
                
                // åªæ·»åŠ æœ‰ä½¿ç”¨æ—¶é—´çš„åˆ†ç±»
                val hasUsage = realHourlyMinutes.any { it > 0 } || virtualHourlyMinutes.any { it > 0 }
                if (hasUsage) {
                    val categoryColor = com.offtime.app.utils.CategoryUtils.getCategoryColor(category.name)
                    
                    categoryHourlyList.add(CategoryHourlyItem(
                        categoryId = category.id,
                        categoryName = category.name,
                        hourlyRealUsage = realHourlyMinutes,
                        hourlyVirtualUsage = virtualHourlyMinutes,
                        color = categoryColor
                    ))
                }
            }
            
            _categoryHourlyData.value = categoryHourlyList
            android.util.Log.d("HomeViewModel", "åŠ è½½äº†${categoryHourlyList.size}ä¸ªåˆ†ç±»çš„24å°æ—¶æ•°æ®")
            
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "åŠ è½½å„åˆ†ç±»24å°æ—¶æ•°æ®å¤±è´¥", e)
            _categoryHourlyData.value = emptyList()
        }
    }
    
    private fun loadLineChartData(categoryId: Int, period: String) {
        // æš‚æ—¶ç¦ç”¨ç¼“å­˜ä»¥æµ‹è¯•æ•°æ®ä¿®å¤
        // if (lastLoadedCategoryId == categoryId && lastLoadedPeriod == period) {
        //     android.util.Log.d("HomeViewModel", "ä½¿ç”¨ç¼“å­˜çš„æŠ˜çº¿å›¾æ•°æ®: categoryId=$categoryId, period=$period")
        //     return
        // }
        
        viewModelScope.launch {
            try {
                android.util.Log.d("HomeViewModel", "åŠ è½½æŠ˜çº¿å›¾æ•°æ®: categoryId=$categoryId, period=$period")
                
                // æ£€æŸ¥æ±‡æ€»è¡¨æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™è§¦å‘é‡å»º
                val summaryCount = summaryUsageDao.getAllSummaryUsageUser().size
                if (summaryCount == 0) {
                    android.util.Log.w("HomeViewModel", "æ±‡æ€»è¡¨ä¸ºç©ºï¼Œå…ˆç”ŸæˆåŸºç¡€è®°å½•å†è§¦å‘æ•°æ®èšåˆ")
                    // å…ˆç”ŸæˆåŸºç¡€è®°å½•
                    com.offtime.app.service.DataAggregationService.ensureBaseRecords(context)
                    // ç­‰å¾…åŸºç¡€è®°å½•ç”Ÿæˆå®Œæˆ
                    kotlinx.coroutines.delay(2000)
                    // å†è§¦å‘æ•°æ®èšåˆ
                    com.offtime.app.service.DataAggregationService.triggerAggregation(context)
                    // ç­‰å¾…èšåˆå®Œæˆ
                    kotlinx.coroutines.delay(3000)
                }
                
                when (period) {
                    "æ—¥", "ä»Šæ—¥" -> {
                        // è·å–æœ€è¿‘15å¤©çš„æ¯æ—¥æ•°æ®
                        loadLast15DaysData(categoryId, period)
                    }
                    "å‘¨", "è¿‘7æ—¥" -> {
                        // è·å–æœ€è¿‘15å‘¨çš„å¹³å‡æ¯æ—¥ä½¿ç”¨é‡
                        loadLast15WeeksData(categoryId)
                    }
                    "æœˆ", "è¿‘30æ—¥" -> {
                        // è·å–æœ€è¿‘15æœˆçš„å¹³å‡æ¯æ—¥ä½¿ç”¨é‡
                        loadLast15MonthsData(categoryId)
                    }
                }
                
                // æ›´æ–°ç¼“å­˜æ ‡è®°
                lastLoadedCategoryId = categoryId
                lastLoadedPeriod = period
                
            } catch (e: Exception) {
                android.util.Log.e("HomeViewModel", "åŠ è½½æŠ˜çº¿å›¾æ•°æ®å¤±è´¥", e)
                // è®¾ç½®ç©ºæ•°æ®
                _usageLineData.value = emptyList()
                _completionLineData.value = emptyList()
                _rewardPunishmentData.value = emptyList()
            }
        }
    }
    
    /**
     * åŠ è½½æœ€è¿‘15å¤©çš„æ¯æ—¥æ•°æ®
     */
    private suspend fun loadLast15DaysData(categoryId: Int, period: String) {
        android.util.Log.d("HomeViewModel", "å¼€å§‹åŠ è½½æœ€è¿‘15å¤©æ•°æ® - ä½¿ç”¨èšåˆè¡¨")
        
        try {
            // 1. å°è¯•ä»èšåˆè¡¨è·å–æ•°æ®
            val dailyUsageData = summaryUsageDao.getDailyUsageData(categoryId, 15)
            val dailyCompletionData = summaryUsageDao.getDailyCompletionData(categoryId, 15)
            
            android.util.Log.d("HomeViewModel", "èšåˆè¡¨æŸ¥è¯¢ç»“æœ: usage=${dailyUsageData.size}æ¡, completion=${dailyCompletionData.size}æ¡")
            
            // å¦‚æœæ±‡æ€»è¡¨æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨åŸå§‹æ•°æ®å›é€€è®¡ç®—
            if (dailyUsageData.isEmpty()) {
                android.util.Log.w("HomeViewModel", "æ±‡æ€»è¡¨æ— æ•°æ®ï¼Œä½¿ç”¨åŸå§‹æ•°æ®å›é€€è®¡ç®—")
                loadLast15DaysDataFromRaw(categoryId, period)
                return
            }
            
            // 2. ç”Ÿæˆå®Œæ•´çš„15å¤©æ—¶é—´è½´ï¼ˆä»14å¤©å‰åˆ°ä»Šå¤©ï¼‰
            val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
                val calendar = Calendar.getInstance()
            val todayStr = dateFormat.format(Date())
            
            // å…ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰çœŸå®ä½¿ç”¨æ•°æ®çš„æ—¥æœŸï¼Œç¡®å®šç¨‹åºå®‰è£…æ—¶é—´ç‚¹
            var firstUsageDate: String? = null
            for (i in 14 downTo 0) {
                    calendar.time = Date()
                calendar.add(Calendar.DAY_OF_YEAR, -i)
                val date = dateFormat.format(calendar.time)
                
                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                if (realUsage > 0 || virtualUsage > 0) {
                    firstUsageDate = date
                    break
                }
            }
            
            android.util.Log.d("HomeViewModel", "ç¬¬ä¸€ä¸ªæœ‰ä½¿ç”¨æ•°æ®çš„æ—¥æœŸ: $firstUsageDate")
            
            val usageData = mutableListOf<UsageData>()
            val completionData = mutableListOf<UsageData>()
            val rewardPunishmentData = mutableListOf<RewardPunishmentData>()
            
            for (i in 14 downTo 0) {
                calendar.time = Date()
                calendar.add(Calendar.DAY_OF_YEAR, -i)
                val date = dateFormat.format(calendar.time)
                
                // ç”Ÿæˆæ˜¾ç¤ºæ ‡ç­¾
                val displayPeriod = if (i == 0) "ä»Šå¤©" else {
                    val month = calendar.get(Calendar.MONTH) + 1
                    val day = calendar.get(Calendar.DAY_OF_MONTH)
                    "${month}/${day}"
                }
                
                // æŸ¥æ‰¾å¯¹åº”çš„èšåˆæ•°æ®
                val usageRecord = dailyUsageData.find { it.period == date }
                val completionRecord = dailyCompletionData.find { it.period == date }
                
                // å…³é”®ä¿®å¤ï¼šåŸºäºç¨‹åºå®‰è£…æ—¶é—´ç‚¹æ¥åˆ¤æ–­
                val isAfterInstall = if (firstUsageDate != null) {
                    // å¦‚æœæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªä½¿ç”¨æ—¥æœŸï¼Œåˆ™è¯¥æ—¥æœŸåŠä¹‹åéƒ½è§†ä¸ºå®‰è£…å
                    date >= firstUsageDate
                    } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä½¿ç”¨æ•°æ®ï¼Œåˆ™åªæœ‰ä»Šå¤©è§†ä¸ºå®‰è£…å
                    date == todayStr
                    }
                    
                val totalUsageMinutes = if (isAfterInstall) {
                    // ç¨‹åºå®‰è£…åï¼ˆå³ä½¿ä½¿ç”¨æ—¶é—´ä¸º0ï¼‰â†’ å½©è‰²å®çº¿
                        usageRecord?.usageMinutes ?: 0
                    } else {
                    // ç¨‹åºå®‰è£…å‰ â†’ ç°è‰²è™šçº¿
                    -1
                }
                
                val dayCompletionRate = if (isAfterInstall) {
                    // ç¨‹åºå®‰è£…åï¼ˆå³ä½¿å®Œæˆç‡ä¸º0ï¼‰â†’ å½©è‰²å®çº¿
                    completionRecord?.completionRate ?: 0f
                        } else {
                    // ç¨‹åºå®‰è£…å‰ â†’ ç°è‰²è™šçº¿
                    -1f
                }
                
                usageData.add(UsageData(
                    period = displayPeriod,
                    usageMinutes = totalUsageMinutes,
                    completionRate = 0f
                ))
                
                completionData.add(UsageData(
                    period = displayPeriod,
                    usageMinutes = totalUsageMinutes,
                    completionRate = dayCompletionRate
                ))
                
                // æ·»åŠ å¥–ç½šå®Œæˆåº¦æ•°æ®
                val rewardValue = if (isAfterInstall) {
                    // ç¨‹åºå®‰è£…åï¼ŒæŸ¥è¯¢å¥–ç½šè®°å½•
                    val rewardRecord = rewardPunishmentUserDao.getRecordByCategoryAndDate(categoryId, date)
                    if (rewardRecord != null) {
                        // æœ‰å¥–ç½šè®°å½•ï¼Œæ ¹æ®æ˜¯å¦å®Œæˆç›®æ ‡æ¥åˆ¤æ–­å¥–åŠ±å®Œæˆåº¦
                        if (rewardRecord.isGoalMet == 1) {
                            // ç›®æ ‡å®Œæˆï¼Œå¥–åŠ±å®Œæˆåº¦å–å†³äºæ˜¯å¦å·²é¢†å–å¥–åŠ±
                            if (rewardRecord.rewardDone == 1) 100f else 0f
                        } else {
                            // ç›®æ ‡æœªå®Œæˆï¼Œæ²¡æœ‰å¥–åŠ±
                            100f // æ— å¥–åŠ±å¯é¢†å–ï¼Œè§†ä¸º100%å®Œæˆ
                        }
                    } else {
                        // æ— å¥–ç½šè®°å½•ï¼Œéœ€è¦å®æ—¶è®¡ç®—
                        val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                        val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                        val totalUsageSeconds = realUsage + virtualUsage
                        val goal = goalRewardPunishmentUserDao.getUserGoalByCatId(categoryId)
                        if (goal != null) {
                            val goalSeconds = goal.dailyGoalMin * 60
                            val goalMet = when (goal.conditionType) {
                                0 -> totalUsageSeconds <= goalSeconds // å¨±ä¹ç±»ï¼šä½¿ç”¨æ—¶é—´ä¸è¶…è¿‡ç›®æ ‡
                                1 -> totalUsageSeconds >= goalSeconds // å­¦ä¹ ç±»ï¼šä½¿ç”¨æ—¶é—´è¾¾åˆ°ç›®æ ‡
                                else -> false
                            }
                            if (goalMet) 0f else 100f // ç›®æ ‡å®Œæˆæœ‰å¥–åŠ±å¾…é¢†å–(0%)ï¼Œç›®æ ‡æœªå®Œæˆæ— å¥–åŠ±(100%)
                    } else {
                            100f // æ— ç›®æ ‡é…ç½®ï¼Œæ— å¥–åŠ±
                        }
                    }
                } else {
                    // ç¨‹åºå®‰è£…å‰ â†’ ç°è‰²è™šçº¿
                    -1f
                }
                
                val punishmentValue = if (isAfterInstall) {
                    // ç¨‹åºå®‰è£…åï¼ŒæŸ¥è¯¢å¥–ç½šè®°å½•
                    val rewardRecord = rewardPunishmentUserDao.getRecordByCategoryAndDate(categoryId, date)
                    if (rewardRecord != null) {
                        // æœ‰å¥–ç½šè®°å½•ï¼Œæ ¹æ®æ˜¯å¦å®Œæˆç›®æ ‡æ¥åˆ¤æ–­æƒ©ç½šå®Œæˆåº¦
                        if (rewardRecord.isGoalMet == 1) {
                            // ç›®æ ‡å®Œæˆï¼Œæ²¡æœ‰æƒ©ç½š
                            100f // æ— æƒ©ç½šéœ€è¦æ‰§è¡Œï¼Œè§†ä¸º100%å®Œæˆ
                        } else {
                            // ç›®æ ‡æœªå®Œæˆï¼Œæƒ©ç½šå®Œæˆåº¦å–å†³äºæ˜¯å¦å·²æ‰§è¡Œæƒ©ç½š
                            if (rewardRecord.punishDone == 1) 100f else 0f
                        }
                    } else {
                        // æ— å¥–ç½šè®°å½•ï¼Œéœ€è¦å®æ—¶è®¡ç®—
                        val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                        val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                        val totalUsageSeconds = realUsage + virtualUsage
                        val goal = goalRewardPunishmentUserDao.getUserGoalByCatId(categoryId)
                        if (goal != null) {
                            val goalSeconds = goal.dailyGoalMin * 60
                            val goalMet = when (goal.conditionType) {
                                0 -> totalUsageSeconds <= goalSeconds // å¨±ä¹ç±»ï¼šä½¿ç”¨æ—¶é—´ä¸è¶…è¿‡ç›®æ ‡
                                1 -> totalUsageSeconds >= goalSeconds // å­¦ä¹ ç±»ï¼šä½¿ç”¨æ—¶é—´è¾¾åˆ°ç›®æ ‡
                                else -> false
                            }
                            if (goalMet) 100f else 0f // ç›®æ ‡å®Œæˆæ— æƒ©ç½š(100%)ï¼Œç›®æ ‡æœªå®Œæˆæœ‰æƒ©ç½šå¾…æ‰§è¡Œ(0%)
                        } else {
                            100f // æ— ç›®æ ‡é…ç½®ï¼Œæ— æƒ©ç½š
                        }
                    }
                } else {
                    // ç¨‹åºå®‰è£…å‰ â†’ ç°è‰²è™šçº¿
                    -1f
                }
                
                rewardPunishmentData.add(RewardPunishmentData(
                period = displayPeriod,
                    rewardValue = rewardValue,
                    punishmentValue = punishmentValue
                ))
                
                val dataStatus = if (totalUsageMinutes >= 0) "å®‰è£…å" else "å®‰è£…å‰"
                android.util.Log.d("HomeViewModel", "æ—¥æ•°æ®å¤„ç†: $displayPeriod ($date), çŠ¶æ€=$dataStatus, ä½¿ç”¨æ—¶é—´=${totalUsageMinutes}åˆ†é’Ÿ, å®Œæˆç‡=$dayCompletionRate, å¥–åŠ±=${rewardValue}%, æƒ©ç½š=${punishmentValue}%")
        }

            // 3. è®¾ç½®æ•°æ®
            _usageLineData.value = usageData
            _completionLineData.value = completionData
            _rewardPunishmentData.value = rewardPunishmentData
            
            android.util.Log.d("HomeViewModel", "æœ€è¿‘15å¤©æ•°æ®åŠ è½½å®Œæˆ: usage=${usageData.size}æ¡, completion=${completionData.size}æ¡, reward=${rewardPunishmentData.size}æ¡")
            
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "åŠ è½½æœ€è¿‘15å¤©æ•°æ®å¤±è´¥", e)
            // å°è¯•ä½¿ç”¨åŸå§‹æ•°æ®å›é€€
            loadLast15DaysDataFromRaw(categoryId, period)
        }
    }
    
    /**
     * ä»åŸå§‹æ•°æ®è®¡ç®—æœ€è¿‘15å¤©çš„æ•°æ®ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
     */
    private suspend fun loadLast15DaysDataFromRaw(categoryId: Int, @Suppress("UNUSED_PARAMETER") period: String) {
        android.util.Log.d("HomeViewModel", "ä½¿ç”¨åŸå§‹æ•°æ®è®¡ç®—æœ€è¿‘15å¤©æ•°æ®")
        
        try {
            val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
            val calendar = Calendar.getInstance()
            val todayStr = dateFormat.format(Date())
            
            // å…ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰çœŸå®ä½¿ç”¨æ•°æ®çš„æ—¥æœŸï¼Œç¡®å®šç¨‹åºå®‰è£…æ—¶é—´ç‚¹
            var firstUsageDate: String? = null
            for (i in 14 downTo 0) {
                calendar.time = Date()
                calendar.add(Calendar.DAY_OF_YEAR, -i)
                val date = dateFormat.format(calendar.time)
                
                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                if (realUsage > 0 || virtualUsage > 0) {
                    firstUsageDate = date
                    break
                }
            }
            
            android.util.Log.d("HomeViewModel", "å›é€€æ–¹æ³• - ç¬¬ä¸€ä¸ªæœ‰ä½¿ç”¨æ•°æ®çš„æ—¥æœŸ: $firstUsageDate")
            
            val usageData = mutableListOf<UsageData>()
            val completionData = mutableListOf<UsageData>()
            val rewardPunishmentData = mutableListOf<RewardPunishmentData>()
            
            for (i in 14 downTo 0) {
                calendar.time = Date()
                calendar.add(Calendar.DAY_OF_YEAR, -i)
                val date = dateFormat.format(calendar.time)
                
                // ç”Ÿæˆæ˜¾ç¤ºæ ‡ç­¾
                val displayPeriod = if (i == 0) "ä»Šå¤©" else {
                    val month = calendar.get(Calendar.MONTH) + 1
                    val day = calendar.get(Calendar.DAY_OF_MONTH)
                    "${month}/${day}"
                }
                
                // å…³é”®ä¿®å¤ï¼šåŸºäºç¨‹åºå®‰è£…æ—¶é—´ç‚¹æ¥åˆ¤æ–­
                val isAfterInstall = if (firstUsageDate != null) {
                    // å¦‚æœæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªä½¿ç”¨æ—¥æœŸï¼Œåˆ™è¯¥æ—¥æœŸåŠä¹‹åéƒ½è§†ä¸ºå®‰è£…å
                    date >= firstUsageDate
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä½¿ç”¨æ•°æ®ï¼Œåˆ™åªæœ‰ä»Šå¤©è§†ä¸ºå®‰è£…å
                    date == todayStr
                }
                
                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                
                val totalUsageMinutes = if (isAfterInstall) {
                    // ç¨‹åºå®‰è£…åï¼ˆå³ä½¿ä½¿ç”¨æ—¶é—´ä¸º0ï¼‰â†’ å½©è‰²å®çº¿
                    val minutes = (realUsage + virtualUsage) / 60
                    android.util.Log.d("HomeViewModel", "ç¨‹åºå®‰è£…å$date: totalMinutes=$minutes")
                    minutes
                } else {
                    // ç¨‹åºå®‰è£…å‰ â†’ ç°è‰²è™šçº¿
                    android.util.Log.d("HomeViewModel", "ç¨‹åºå®‰è£…å‰$date: è®¾ç½®ä¸º-1")
                    -1
                }
                
                usageData.add(UsageData(
                    period = displayPeriod,
                    usageMinutes = totalUsageMinutes,
                    completionRate = 0f
                ))
                
                // è®¡ç®—å®Œæˆç‡ - ä½¿ç”¨ç›¸åŒçš„é€»è¾‘
                val completionRate = if (isAfterInstall) {
                    // ç¨‹åºå®‰è£…å â†’ å½©è‰²å®çº¿
                    val rewardPunishmentRecord = rewardPunishmentUserDao.getByDateAndCategory(categoryId, date)
                    if (rewardPunishmentRecord != null) {
                        // ä»å¥–ç½šè®°å½•ä¸­è·å–å®Œæˆç‡
                        if (rewardPunishmentRecord.isGoalMet == 1) 100f else 0f
                    } else {
                        // æœ‰çœŸå®ä½¿ç”¨æ•°æ®ä½†æ— å¥–ç½šè®°å½•ï¼Œéœ€è¦è®¡ç®—ç›®æ ‡å®Œæˆæƒ…å†µ
                        val totalUsageSeconds = realUsage + virtualUsage
                        val goal = goalRewardPunishmentUserDao.getUserGoalByCatId(categoryId)
                        if (goal != null) {
                            val goalSeconds = goal.dailyGoalMin * 60
                            val goalMet = when (goal.conditionType) {
                                0 -> totalUsageSeconds <= goalSeconds // ä½¿ç”¨æ—¶é—´ä¸è¶…è¿‡ç›®æ ‡
                                1 -> totalUsageSeconds >= goalSeconds // ä½¿ç”¨æ—¶é—´è¾¾åˆ°ç›®æ ‡
                                else -> false
                            }
                            if (goalMet) 100f else 0f
                        } else {
                            0f
                        }
                    }
                    } else {
                    // ç¨‹åºå®‰è£…å‰ â†’ ç°è‰²è™šçº¿
                        -1f
                    }
                
                completionData.add(UsageData(
                    period = displayPeriod,
                    usageMinutes = totalUsageMinutes,
                    completionRate = completionRate
                ))
                
                // æ·»åŠ å¥–ç½šå®Œæˆåº¦æ•°æ®ï¼ˆä¸ä¸»æ–¹æ³•ç›¸åŒçš„é€»è¾‘ï¼‰
                val rewardValue = if (isAfterInstall) {
                    val rewardRecord = rewardPunishmentUserDao.getByDateAndCategory(categoryId, date)
                    if (rewardRecord != null) {
                        if (rewardRecord.isGoalMet == 1) {
                            if (rewardRecord.rewardDone == 1) 100f else 0f
                            } else {
                            100f // ç›®æ ‡æœªå®Œæˆï¼Œæ— å¥–åŠ±
                            }
                        } else {
                        val totalUsageSeconds = realUsage + virtualUsage
                        val goal = goalRewardPunishmentUserDao.getUserGoalByCatId(categoryId)
                        if (goal != null) {
                            val goalSeconds = goal.dailyGoalMin * 60
                            val goalMet = when (goal.conditionType) {
                                0 -> totalUsageSeconds <= goalSeconds
                                1 -> totalUsageSeconds >= goalSeconds
                                else -> false
                            }
                            if (goalMet) 0f else 100f
                        } else {
                            100f
                        }
                    }
                    } else {
                    -1f
                }
                
                val punishmentValue = if (isAfterInstall) {
                    val rewardRecord = rewardPunishmentUserDao.getByDateAndCategory(categoryId, date)
                    if (rewardRecord != null) {
                        if (rewardRecord.isGoalMet == 1) {
                            100f // ç›®æ ‡å®Œæˆï¼Œæ— æƒ©ç½š
                        } else {
                            if (rewardRecord.punishDone == 1) 100f else 0f
                        }
                    } else {
                        val totalUsageSeconds = realUsage + virtualUsage
                        val goal = goalRewardPunishmentUserDao.getUserGoalByCatId(categoryId)
                        if (goal != null) {
                            val goalSeconds = goal.dailyGoalMin * 60
                            val goalMet = when (goal.conditionType) {
                                0 -> totalUsageSeconds <= goalSeconds
                                1 -> totalUsageSeconds >= goalSeconds
                                else -> false
                            }
                            if (goalMet) 100f else 0f
                    } else {
                            100f
                        }
                    }
                    } else {
                    -1f
                }
                
                rewardPunishmentData.add(RewardPunishmentData(
                period = displayPeriod,
                rewardValue = rewardValue,
                punishmentValue = punishmentValue
                ))
                
                val dataStatus = if (totalUsageMinutes >= 0) "å®‰è£…å" else "å®‰è£…å‰"
                android.util.Log.d("HomeViewModel", "åŸå§‹æ•°æ®è®¡ç®—: $displayPeriod ($date), çŠ¶æ€=$dataStatus, ä½¿ç”¨æ—¶é—´=${totalUsageMinutes}åˆ†é’Ÿ, å®Œæˆç‡=$completionRate, å¥–åŠ±=${rewardValue}%, æƒ©ç½š=${punishmentValue}%")
            }
            
            _usageLineData.value = usageData
            _completionLineData.value = completionData
            _rewardPunishmentData.value = rewardPunishmentData
            _shouldShowRewardChart.value = !rewardEmpty
            _shouldShowPunishmentChart.value = !punishmentEmpty
            
            android.util.Log.d("HomeViewModel", "åŸå§‹æ•°æ®å›é€€è®¡ç®—å®Œæˆ: usage=${usageData.size}æ¡, completion=${completionData.size}æ¡, reward=${rewardPunishmentData.size}æ¡")
            
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "åŸå§‹æ•°æ®å›é€€è®¡ç®—å¤±è´¥", e)
            _usageLineData.value = emptyList()
            _completionLineData.value = emptyList()
            _rewardPunishmentData.value = emptyList()
        }
    }
    
    /**
     * åŠ è½½æœ€è¿‘15å‘¨çš„å¹³å‡æ¯æ—¥ä½¿ç”¨é‡ - ä½¿ç”¨èšåˆè¡¨ä¼˜åŒ–
     */
    private suspend fun loadLast15WeeksData(categoryId: Int) {
        android.util.Log.d("HomeViewModel", "å¼€å§‹åŠ è½½æœ€è¿‘15å‘¨æ•°æ® - ä½¿ç”¨èšåˆè¡¨")
        
        try {
            // 1. ä»èšåˆè¡¨è·å–æ•°æ®
            val weeklyUsageData = summaryUsageDao.getWeeklyUsageData(categoryId, 15)
            val weeklyCompletionData = summaryUsageDao.getWeeklyCompletionData(categoryId, 15)
            
            android.util.Log.d("HomeViewModel", "èšåˆè¡¨æŸ¥è¯¢ç»“æœ: usage=${weeklyUsageData.size}æ¡, completion=${weeklyCompletionData.size}æ¡")
            
            // 2. ç”Ÿæˆå®Œæ•´çš„15å‘¨æ—¶é—´è½´ï¼ˆä»14å‘¨å‰åˆ°æœ¬å‘¨ï¼‰
            val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
            val calendar = Calendar.getInstance()
            val today = Calendar.getInstance()
            
            // å…ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰çœŸå®ä½¿ç”¨æ•°æ®çš„å‘¨ï¼Œç¡®å®šç¨‹åºå®‰è£…æ—¶é—´ç‚¹
            var firstUsageWeek: String? = null
            for (i in 14 downTo 0) {
                calendar.time = Date()
                calendar.add(Calendar.WEEK_OF_YEAR, -i)
                calendar.set(Calendar.DAY_OF_WEEK, Calendar.MONDAY)
                val weekStart = dateFormat.format(calendar.time)
                
                // æ£€æŸ¥è¯¥å‘¨æ˜¯å¦æœ‰çœŸå®ä½¿ç”¨æ•°æ®
                var hasRealUsage = false
                    val tempCalendar = Calendar.getInstance()
                    tempCalendar.time = calendar.time
                    
                    for (day in 0..6) {
                        val checkDate = dateFormat.format(tempCalendar.time)
                        val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, checkDate, 0) ?: 0
                        val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, checkDate, 1) ?: 0
                        if (realUsage > 0 || virtualUsage > 0) {
                        hasRealUsage = true
                        break
                        }
                        tempCalendar.add(Calendar.DAY_OF_YEAR, 1)
                        
                        // ä¸èƒ½è¶…è¿‡ä»Šå¤©
                        if (tempCalendar.time.after(today.time)) break
                    }
                
                if (hasRealUsage) {
                    firstUsageWeek = weekStart
                    break
                }
            }
            
            android.util.Log.d("HomeViewModel", "ç¬¬ä¸€ä¸ªæœ‰ä½¿ç”¨æ•°æ®çš„å‘¨: $firstUsageWeek")
            
            val usageData = mutableListOf<UsageData>()
            val completionData = mutableListOf<UsageData>()
            val rewardPunishmentData = mutableListOf<RewardPunishmentData>()
            
            for (i in 14 downTo 0) {
                calendar.time = Date()
                calendar.add(Calendar.WEEK_OF_YEAR, -i)
                calendar.set(Calendar.DAY_OF_WEEK, Calendar.MONDAY)
                val weekStart = dateFormat.format(calendar.time)
                
                // ç”Ÿæˆæ˜¾ç¤ºæ ‡ç­¾
                val displayPeriod = if (i == 0) "æœ¬å‘¨" else {
                    val weekNumber = calendar.get(Calendar.WEEK_OF_YEAR)
                    val year = calendar.get(Calendar.YEAR).toString().takeLast(2)
                    "$year-$weekNumber"
                }
                
                // æŸ¥æ‰¾å¯¹åº”çš„èšåˆæ•°æ®
                val usageRecord = weeklyUsageData.find { it.period == weekStart }
                val completionRecord = weeklyCompletionData.find { it.period == weekStart }
                
                // åˆ¤æ–­è¯¥å‘¨æ˜¯å¦åœ¨ç¨‹åºå®‰è£…å
                val isAfterInstall = if (firstUsageWeek != null) {
                    // å¦‚æœæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªä½¿ç”¨å‘¨ï¼Œåˆ™è¯¥å‘¨åŠä¹‹åéƒ½è§†ä¸ºå®‰è£…å
                    weekStart >= firstUsageWeek
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä½¿ç”¨æ•°æ®ï¼Œåˆ™åªæœ‰æœ¬å‘¨è§†ä¸ºå®‰è£…å
                    i == 0
                }
                
                // ä½¿ç”¨æ—¶é—´æ•°æ®ï¼šæ ¹æ®æ˜¯å¦åœ¨å®‰è£…åæ¥åˆ¤æ–­
                val weekUsageMinutes = if (isAfterInstall) {
                    usageRecord?.usageMinutes ?: 0 // å®‰è£…åï¼Œä½¿ç”¨å®é™…å€¼æˆ–0 â†’ å½©è‰²å®çº¿
                } else {
                    -1 // å®‰è£…å‰ â†’ ç°è‰²è™šçº¿
                }
                
                usageData.add(UsageData(
                    period = displayPeriod,
                    usageMinutes = weekUsageMinutes,
                    completionRate = 0f
                ))
                
                // å®Œæˆç‡æ•°æ®ï¼šæ ¹æ®æ˜¯å¦åœ¨å®‰è£…åæ¥åˆ¤æ–­
                val weekCompletionRate = if (isAfterInstall) {
                    completionRecord?.completionRate ?: 0f // å®‰è£…åï¼Œä½¿ç”¨å®é™…å€¼æˆ–0 â†’ å½©è‰²å®çº¿
                } else {
                    -1f // å®‰è£…å‰ â†’ ç°è‰²è™šçº¿
                }
                
                completionData.add(UsageData(
                    period = displayPeriod,
                    usageMinutes = weekUsageMinutes, // ä½¿ç”¨ç›¸åŒçš„é€»è¾‘åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®
                    completionRate = weekCompletionRate
                ))
                
                val dataStatus = if (weekUsageMinutes >= 0) "å®‰è£…å" else "å®‰è£…å‰"
                android.util.Log.d("HomeViewModel", "å‘¨æ•°æ®å¤„ç†: $displayPeriod, çŠ¶æ€=$dataStatus, ä½¿ç”¨æ—¶é—´=${weekUsageMinutes}åˆ†é’Ÿ, å®Œæˆç‡=$weekCompletionRate")
                
                // å¥–åŠ±æƒ©ç½šæ•°æ®
                try {
                    if (i == 0) {
                        // æœ¬å‘¨ï¼šå®æ—¶è®¡ç®—æœ¬å‘¨åˆ°ç›®å‰ä¸ºæ­¢çš„å¥–ç½šå®Œæˆåº¦
                        val weekDateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
                        val tempCalendar = Calendar.getInstance()
                        tempCalendar.time = calendar.time // æœ¬å‘¨å‘¨ä¸€
                        
                        var totalRewardCount = 0
                        var doneRewardCount = 0
                        var totalPunishCount = 0
                        var donePunishCount = 0
                        var hasAnyData = false
                        
                        // ä»æœ¬å‘¨å‘¨ä¸€åˆ°ä»Šå¤©ï¼ˆä¸åŒ…æ‹¬ä»Šå¤©ï¼‰
                        android.util.Log.d("HomeViewModel", "æœ¬å‘¨å¥–ç½šæ•°æ®è®¡ç®—å¼€å§‹: æœ¬å‘¨å‘¨ä¸€=${weekDateFormat.format(tempCalendar.time)}, ä»Šå¤©=${weekDateFormat.format(today.time)}")
                        while (tempCalendar.time.before(today.time)) {
                            val checkDate = weekDateFormat.format(tempCalendar.time)
                            val rewardRecord = rewardPunishmentUserDao.getRecordByCategoryAndDate(categoryId, checkDate)
                            
                            android.util.Log.d("HomeViewModel", "æ£€æŸ¥æ—¥æœŸ $checkDate: å¥–ç½šè®°å½•=${rewardRecord != null}")
                            
                            if (rewardRecord != null) {
                                hasAnyData = true
                                totalRewardCount++
                                totalPunishCount++
                                if (rewardRecord.rewardDone == 1) doneRewardCount++
                                if (rewardRecord.punishDone == 1) donePunishCount++
                                android.util.Log.d("HomeViewModel", "$checkDate æœ‰å¥–ç½šè®°å½•: reward=${rewardRecord.rewardDone}, punishment=${rewardRecord.punishDone}")
                            } else {
                                // æ£€æŸ¥æ˜¯å¦æœ‰ä½¿ç”¨æ•°æ®
                                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, checkDate, 0) ?: 0
                                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, checkDate, 1) ?: 0
                                android.util.Log.d("HomeViewModel", "$checkDate æ— å¥–ç½šè®°å½•, ä½¿ç”¨æ•°æ®: real=$realUsage, virtual=$virtualUsage")
                                if (realUsage > 0 || virtualUsage > 0) {
                                    hasAnyData = true
                                    totalRewardCount++
                                    totalPunishCount++
                                    android.util.Log.d("HomeViewModel", "$checkDate æœ‰ä½¿ç”¨æ•°æ®ä½†æ— å¥–ç½šè®°å½•ï¼Œç®—ä½œæœªå®Œæˆ")
                                    // æ²¡æœ‰å¥–ç½šè®°å½•ä½†æœ‰ä½¿ç”¨æ•°æ®ï¼Œç®—ä½œæœªå®Œæˆ
                                }
                            }
                            tempCalendar.add(Calendar.DAY_OF_YEAR, 1)
                        }
                        
                        android.util.Log.d("HomeViewModel", "æœ¬å‘¨å¥–ç½šç»Ÿè®¡: hasData=$hasAnyData, æ€»å¥–åŠ±=$totalRewardCount, å®Œæˆå¥–åŠ±=$doneRewardCount, æ€»æƒ©ç½š=$totalPunishCount, å®Œæˆæƒ©ç½š=$donePunishCount")
                        
                        if (hasAnyData) {
                            val rewardCompletion = if (totalRewardCount > 0) {
                                (doneRewardCount.toFloat() / totalRewardCount * 100).coerceAtMost(100f)
                            } else 0f
                            val punishmentCompletion = if (totalPunishCount > 0) {
                                (donePunishCount.toFloat() / totalPunishCount * 100).coerceAtMost(100f)
                            } else 0f
                            
                            android.util.Log.d("HomeViewModel", "æœ¬å‘¨æœ€ç»ˆå®Œæˆç‡: å¥–åŠ±=$rewardCompletion%, æƒ©ç½š=$punishmentCompletion%")
                            
                            rewardPunishmentData.add(RewardPunishmentData(
                                period = displayPeriod,
                                rewardValue = rewardCompletion,
                                punishmentValue = punishmentCompletion
                            ))
                        } else {
                            // æœ¬å‘¨æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œä½†åº”è¯¥è®¤ä¸ºæœ‰æ•°æ®ï¼ˆå¥–ç½šå®Œæˆåº¦ä¸º0ï¼‰
                            android.util.Log.d("HomeViewModel", "æœ¬å‘¨æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œè®¾ç½®ä¸º0%å®Œæˆåº¦")
                            rewardPunishmentData.add(RewardPunishmentData(
                                period = displayPeriod,
                                rewardValue = 0f,
                                punishmentValue = 0f
                            ))
                        }
                    } else {
                        // å†å²å‘¨ï¼šä½¿ç”¨èšåˆè¡¨æ•°æ®
                        val weekRecord = rewardPunishmentWeekUserDao.getRecordByCategoryAndWeek(categoryId, weekStart)
                        android.util.Log.d("HomeViewModel", "å†å²å‘¨ $displayPeriod ($weekStart): èšåˆè®°å½•=${weekRecord != null}")
                        
                        if (weekRecord != null && (weekRecord.totalRewardCount > 0 || weekRecord.totalPunishCount > 0)) {
                            android.util.Log.d("HomeViewModel", "å†å²å‘¨ $displayPeriod èšåˆæ•°æ®: æ€»å¥–åŠ±=${weekRecord.totalRewardCount}, å®Œæˆå¥–åŠ±=${weekRecord.doneRewardCount}, æ€»æƒ©ç½š=${weekRecord.totalPunishCount}, å®Œæˆæƒ©ç½š=${weekRecord.donePunishCount}")
                            
                            val rewardCompletion = if (weekRecord.totalRewardCount > 0) {
                                (weekRecord.doneRewardCount.toFloat() / weekRecord.totalRewardCount * 100).coerceAtMost(100f)
                            } else 0f
                            val punishmentCompletion = if (weekRecord.totalPunishCount > 0) {
                                (weekRecord.donePunishCount.toFloat() / weekRecord.totalPunishCount * 100).coerceAtMost(100f)
                            } else 0f
                            
                            android.util.Log.d("HomeViewModel", "å†å²å‘¨ $displayPeriod æœ€ç»ˆå®Œæˆç‡: å¥–åŠ±=$rewardCompletion%, æƒ©ç½š=$punishmentCompletion%")
                            
                            rewardPunishmentData.add(RewardPunishmentData(
                                period = displayPeriod,
                                rewardValue = rewardCompletion,
                                punishmentValue = punishmentCompletion
                            ))
                        } else {
                            // è¯¥å‘¨æ²¡æœ‰æ•°æ®
                            android.util.Log.d("HomeViewModel", "å†å²å‘¨ $displayPeriod æ²¡æœ‰æ•°æ®")
                            rewardPunishmentData.add(RewardPunishmentData(
                                period = displayPeriod,
                                rewardValue = -1f,
                                punishmentValue = -1f
                            ))
                        }
                    }
                } catch (e: Exception) {
                    android.util.Log.e("HomeViewModel", "è·å–å‘¨å¥–åŠ±æƒ©ç½šæ•°æ®å¤±è´¥: $e")
                    rewardPunishmentData.add(RewardPunishmentData(
                        period = displayPeriod,
                        rewardValue = -1f,
                        punishmentValue = -1f
                    ))
                }
                
                android.util.Log.d("HomeViewModel", "å‘¨æ•°æ®: $displayPeriod, ä½¿ç”¨æ—¶é—´=${usageRecord?.usageMinutes ?: 0}åˆ†é’Ÿ")
            }
            
            _usageLineData.value = usageData
            _completionLineData.value = completionData
            _rewardPunishmentData.value = rewardPunishmentData
            
            android.util.Log.d("HomeViewModel", "æœ€è¿‘15å‘¨æ•°æ®åŠ è½½å®Œæˆ: usage=${usageData.size}æ¡, completion=${completionData.size}æ¡, reward=${rewardPunishmentData.size}æ¡")
            android.util.Log.d("HomeViewModel", "å‘¨æ ‡ç­¾: ${usageData.map { it.period }}")
            
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "ä»èšåˆè¡¨åŠ è½½å‘¨æ•°æ®å¤±è´¥ï¼Œå›é€€åˆ°åŸæœ‰é€»è¾‘", e)
            // å¦‚æœèšåˆè¡¨æŸ¥è¯¢å¤±è´¥ï¼Œå›é€€åˆ°åŸæœ‰çš„å®æ—¶è®¡ç®—é€»è¾‘
            loadLast15WeeksDataFallback(categoryId)
        }
    }
    
    /**
     * å‘¨æ•°æ®åŠ è½½çš„å›é€€æ–¹æ³•ï¼ˆåŸæœ‰çš„å®æ—¶è®¡ç®—é€»è¾‘ï¼‰- ä¿®æ”¹ä¸ºä½¿ç”¨å®é™…å¤©æ•°
     */
    private suspend fun loadLast15WeeksDataFallback(categoryId: Int) {
        android.util.Log.d("HomeViewModel", "ä½¿ç”¨å›é€€æ–¹æ³•åŠ è½½å‘¨æ•°æ®")
        
        val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
        val calendar = Calendar.getInstance()
        val today = Calendar.getInstance()
        
        // ç”Ÿæˆæœ€è¿‘15å‘¨çš„å‘¨æœŸåˆ—è¡¨
        val weekList = mutableListOf<String>()
        for (i in 14 downTo 0) {
            calendar.time = Date()
            calendar.add(Calendar.WEEK_OF_YEAR, -i)
            
            if (i == 0) {
                weekList.add("æœ¬å‘¨")
            } else {
                val weekNumber = calendar.get(Calendar.WEEK_OF_YEAR)
                calendar.set(Calendar.DAY_OF_WEEK, Calendar.MONDAY)
                val mondayYear = calendar.get(Calendar.YEAR)
                val finalYear = mondayYear.toString().takeLast(2)
                weekList.add("$finalYear-$weekNumber")
            }
        }
        
        // å®æ—¶è®¡ç®—é€»è¾‘ï¼ˆä¿®æ”¹ä¸ºä½¿ç”¨å®é™…å¤©æ•°ï¼‰
        val usageData = mutableListOf<UsageData>()
        for (i in weekList.indices) {
            calendar.time = Date()
            calendar.add(Calendar.WEEK_OF_YEAR, -(14-i))
            calendar.set(Calendar.DAY_OF_WEEK, Calendar.MONDAY)
            
            var weeklyTotalMinutes = 0
            var actualDaysWithData = 0
            
            for (day in 0..6) {
                val date = dateFormat.format(calendar.time)
                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                val dailyMinutes = (realUsage + virtualUsage) / 60
                
                weeklyTotalMinutes += dailyMinutes
                if (dailyMinutes > 0) {
                    actualDaysWithData++
                }
                
                calendar.add(Calendar.DAY_OF_YEAR, 1)
                
                // ä¸èƒ½è¶…è¿‡ä»Šå¤©
                if (calendar.time.after(today.time)) break
            }
            
            // ä½¿ç”¨å®é™…æœ‰æ•°æ®çš„å¤©æ•°è®¡ç®—å¹³å‡å€¼ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™ä½¿ç”¨0
            val avgDailyMinutes = if (actualDaysWithData > 0) {
                weeklyTotalMinutes / actualDaysWithData
            } else {
                0
            }
            
            usageData.add(UsageData(
                period = weekList[i],
                usageMinutes = avgDailyMinutes,
                completionRate = 0f
            ))
            
            android.util.Log.d("HomeViewModel", "å‘¨æ•°æ®å›é€€: ${weekList[i]}, æ€»æ—¶é•¿=${weeklyTotalMinutes}åˆ†é’Ÿ, æœ‰æ•°æ®å¤©æ•°=$actualDaysWithData, å¹³å‡æ¯æ—¥=${avgDailyMinutes}åˆ†é’Ÿ")
        }
        
        val completionData = mutableListOf<UsageData>()
        for (i in weekList.indices) {
            calendar.time = Date()
            calendar.add(Calendar.WEEK_OF_YEAR, -(14-i))
            calendar.set(Calendar.DAY_OF_WEEK, Calendar.MONDAY)
            
            var totalCompletionRate = 0f
            var actualDaysWithData = 0
            
            for (day in 0..6) {
                val date = dateFormat.format(calendar.time)
                val dailyCompletionRate = calculateDailyGoalCompletionRate(categoryId, date)
                
                // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦æœ‰ä½¿ç”¨æ•°æ®
                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                
                if (realUsage > 0 || virtualUsage > 0) {
                    totalCompletionRate += dailyCompletionRate
                    actualDaysWithData++
                }
                
                calendar.add(Calendar.DAY_OF_YEAR, 1)
                
                // ä¸èƒ½è¶…è¿‡ä»Šå¤©
                if (calendar.time.after(today.time)) break
            }
            
            // ä½¿ç”¨å®é™…æœ‰æ•°æ®çš„å¤©æ•°è®¡ç®—å¹³å‡å®Œæˆç‡
            val avgCompletionRate = if (actualDaysWithData > 0) {
                totalCompletionRate / actualDaysWithData
            } else {
                0f
            }
            
            completionData.add(UsageData(
                period = weekList[i],
                usageMinutes = 0,
                completionRate = avgCompletionRate
            ))
        }
        
        _usageLineData.value = usageData
        _completionLineData.value = completionData
        _rewardPunishmentData.value = emptyList()
    }
    
    /**
     * åŠ è½½æœ€è¿‘15æœˆçš„å¹³å‡æ¯æ—¥ä½¿ç”¨é‡ - ä½¿ç”¨èšåˆè¡¨ä¼˜åŒ–
     */
    private suspend fun loadLast15MonthsData(categoryId: Int) {
        android.util.Log.d("HomeViewModel", "å¼€å§‹åŠ è½½æœ€è¿‘15æœˆæ•°æ® - ä½¿ç”¨èšåˆè¡¨")
        
        try {
            // 1. ä»èšåˆè¡¨è·å–æ•°æ®
            val monthlyUsageData = summaryUsageDao.getMonthlyUsageData(categoryId, 15)
            val monthlyCompletionData = summaryUsageDao.getMonthlyCompletionData(categoryId, 15)
            
            android.util.Log.d("HomeViewModel", "èšåˆè¡¨æŸ¥è¯¢ç»“æœ: usage=${monthlyUsageData.size}æ¡, completion=${monthlyCompletionData.size}æ¡")
            
            // 2. ç”Ÿæˆå®Œæ•´çš„15æœˆæ—¶é—´è½´ï¼ˆä»14æœˆå‰åˆ°æœ¬æœˆï¼‰
            val monthFormat = SimpleDateFormat("yyyy-MM", Locale.getDefault())
            val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
            val calendar = Calendar.getInstance()
            val today = Calendar.getInstance()
            
            val usageData = mutableListOf<UsageData>()
            val completionData = mutableListOf<UsageData>()
            val rewardPunishmentData = mutableListOf<RewardPunishmentData>()
            
            for (i in 14 downTo 0) {
                calendar.time = Date()
                calendar.add(Calendar.MONTH, -i)
                val month = monthFormat.format(calendar.time)
                
                // ç”Ÿæˆæ˜¾ç¤ºæ ‡ç­¾
                val displayPeriod = if (i == 0) "æœ¬æœˆ" else {
                    val parts = month.split("-")
                    if (parts.size == 2) {
                        val year = parts[0].takeLast(2)
                        val monthNum = parts[1]
                        "$year-$monthNum"
                    } else {
                        month
                    }
                }
                
                // æŸ¥æ‰¾å¯¹åº”çš„èšåˆæ•°æ®
                val usageRecord = monthlyUsageData.find { it.period == month }
                val completionRecord = monthlyCompletionData.find { it.period == month }
                
                // è®¡ç®—å®é™…æœ‰æ•°æ®çš„å¤©æ•°ï¼ˆå¯¹äºæœ¬æœˆå’Œå†å²æœˆçš„å¤„ç†ï¼‰
                val actualDaysInMonth = if (i == 0) {
                    // æœ¬æœˆï¼šä»1å·åˆ°ä»Šå¤©çš„å¤©æ•°
                    today.get(Calendar.DAY_OF_MONTH)
                } else {
                    // å†å²æœˆï¼šæ£€æŸ¥è¯¥æœˆå®é™…æœ‰æ•°æ®çš„å¤©æ•°
                    calendar.time = Date()
                    calendar.add(Calendar.MONTH, -i)
                    calendar.set(Calendar.DAY_OF_MONTH, 1)
                    val monthStart = calendar.time
                    calendar.add(Calendar.MONTH, 1)
                    calendar.add(Calendar.DAY_OF_YEAR, -1)
                    val monthEnd = calendar.time
                    
                    var daysWithData = 0
                    val tempCalendar = Calendar.getInstance()
                    tempCalendar.time = monthStart
                    
                    while (tempCalendar.time <= monthEnd && !tempCalendar.time.after(today.time)) {
                        val checkDate = dateFormat.format(tempCalendar.time)
                        // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦æœ‰ä½¿ç”¨æ•°æ®
                        val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, checkDate, 0) ?: 0
                        val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, checkDate, 1) ?: 0
                        if (realUsage > 0 || virtualUsage > 0) {
                            daysWithData++
                        }
                        tempCalendar.add(Calendar.DAY_OF_YEAR, 1)
                    }
                    
                    if (daysWithData == 0) {
                        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨è¯¥æœˆçš„å®é™…å¤©æ•°
                        val daysInMonth = Calendar.getInstance().apply {
                            time = monthStart
                            add(Calendar.MONTH, 1)
                            add(Calendar.DAY_OF_YEAR, -1)
                        }.get(Calendar.DAY_OF_MONTH)
                        daysInMonth
                    } else {
                        daysWithData
                    }
                }
                
                // åˆ¤æ–­è¯¥æœˆæ˜¯å¦æœ‰çœŸå®ä½¿ç”¨æ•°æ®
                val hasMonthRealData = if (i == 0) {
                    // æœ¬æœˆï¼šåº”è¯¥æ€»æ˜¯æœ‰æ•°æ®ï¼ˆç±»ä¼¼ä»Šå¤©çš„é€»è¾‘ï¼‰
                    true
                } else {
                    // å†å²æœˆï¼šæ£€æŸ¥è¯¥æœˆæ˜¯å¦æœ‰çœŸå®ä½¿ç”¨æ•°æ®
                    calendar.time = Date()
                    calendar.add(Calendar.MONTH, -i)
                    calendar.set(Calendar.DAY_OF_MONTH, 1)
                    val monthStart = calendar.time
                    calendar.add(Calendar.MONTH, 1)
                    calendar.add(Calendar.DAY_OF_YEAR, -1)
                    val monthEnd = calendar.time
                    
                    var hasRealUsage = false
                    val tempCalendar = Calendar.getInstance()
                    tempCalendar.time = monthStart
                    
                    while (tempCalendar.time <= monthEnd && !tempCalendar.time.after(today.time)) {
                        val checkDate = dateFormat.format(tempCalendar.time)
                        val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, checkDate, 0) ?: 0
                        val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, checkDate, 1) ?: 0
                        if (realUsage > 0 || virtualUsage > 0) {
                            hasRealUsage = true
                            break
                        }
                        tempCalendar.add(Calendar.DAY_OF_YEAR, 1)
                    }
                    hasRealUsage
                }
                
                // ä½¿ç”¨æ—¶é—´æ•°æ®ï¼šæ ¹æ®æ˜¯å¦æœ‰çœŸå®ä½¿ç”¨æ•°æ®æ¥åˆ¤æ–­
                val monthUsageMinutes = if (hasMonthRealData) {
                    usageRecord?.usageMinutes ?: 0 // æœ‰çœŸå®æ•°æ®ï¼Œä½¿ç”¨å®é™…å€¼æˆ–0
                } else {
                    -1 // æ— çœŸå®æ•°æ®ï¼ˆç¨‹åºå®‰è£…å‰ï¼‰
                }
                
                usageData.add(UsageData(
                    period = displayPeriod,
                    usageMinutes = monthUsageMinutes,
                    completionRate = 0f
                ))
                
                // å®Œæˆç‡æ•°æ®ï¼šæ ¹æ®æ˜¯å¦æœ‰çœŸå®ä½¿ç”¨æ•°æ®æ¥åˆ¤æ–­
                val monthCompletionRate = if (hasMonthRealData) {
                    completionRecord?.completionRate ?: 0f // æœ‰çœŸå®æ•°æ®ï¼Œä½¿ç”¨å®é™…å€¼æˆ–0
                } else {
                    -1f // æ— çœŸå®æ•°æ®ï¼ˆç¨‹åºå®‰è£…å‰ï¼‰
                }
                
                completionData.add(UsageData(
                    period = displayPeriod,
                    usageMinutes = monthUsageMinutes, // ä½¿ç”¨ç›¸åŒçš„é€»è¾‘åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®
                    completionRate = monthCompletionRate
                ))
                
                val dataStatus = if (monthUsageMinutes >= 0) "å®‰è£…å" else "å®‰è£…å‰"
                android.util.Log.d("HomeViewModel", "æœˆæ•°æ®å¤„ç†: $displayPeriod, çŠ¶æ€=$dataStatus, ä½¿ç”¨æ—¶é—´=${monthUsageMinutes}åˆ†é’Ÿ, å®Œæˆç‡=$monthCompletionRate")
                
                // å¥–åŠ±æƒ©ç½šæ•°æ®
                try {
                    if (i == 0) {
                        // æœ¬æœˆï¼šå®æ—¶è®¡ç®—æœ¬æœˆåˆ°ç›®å‰ä¸ºæ­¢çš„å¥–ç½šå®Œæˆåº¦
                        val monthDateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
                        val tempCalendar = Calendar.getInstance()
                        tempCalendar.time = Date()
                        tempCalendar.add(Calendar.MONTH, -i)
                        tempCalendar.set(Calendar.DAY_OF_MONTH, 1) // æœ¬æœˆ1å·
                        
                        var totalRewardCount = 0
                        var doneRewardCount = 0
                        var totalPunishCount = 0
                        var donePunishCount = 0
                        var hasAnyData = false
                        
                        // ä»æœ¬æœˆ1å·åˆ°ä»Šå¤©ï¼ˆä¸åŒ…æ‹¬ä»Šå¤©ï¼‰
                        while (tempCalendar.time.before(today.time)) {
                            val checkDate = monthDateFormat.format(tempCalendar.time)
                            val rewardRecord = rewardPunishmentUserDao.getRecordByCategoryAndDate(categoryId, checkDate)
                            
                            if (rewardRecord != null) {
                                hasAnyData = true
                                totalRewardCount++
                                totalPunishCount++
                                if (rewardRecord.rewardDone == 1) doneRewardCount++
                                if (rewardRecord.punishDone == 1) donePunishCount++
                            } else {
                                // æ£€æŸ¥æ˜¯å¦æœ‰ä½¿ç”¨æ•°æ®
                                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, checkDate, 0) ?: 0
                                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, checkDate, 1) ?: 0
                                if (realUsage > 0 || virtualUsage > 0) {
                                    hasAnyData = true
                                    totalRewardCount++
                                    totalPunishCount++
                                    // æ²¡æœ‰å¥–ç½šè®°å½•ä½†æœ‰ä½¿ç”¨æ•°æ®ï¼Œç®—ä½œæœªå®Œæˆ
                                }
                            }
                            tempCalendar.add(Calendar.DAY_OF_YEAR, 1)
                        }
                        
                        if (hasAnyData) {
                            val rewardCompletion = if (totalRewardCount > 0) {
                                (doneRewardCount.toFloat() / totalRewardCount * 100).coerceAtMost(100f)
                            } else 0f
                            val punishmentCompletion = if (totalPunishCount > 0) {
                                (donePunishCount.toFloat() / totalPunishCount * 100).coerceAtMost(100f)
                            } else 0f
                            
                            rewardPunishmentData.add(RewardPunishmentData(
                                period = displayPeriod,
                                rewardValue = rewardCompletion,
                                punishmentValue = punishmentCompletion
                            ))
                        } else {
                            // æœ¬æœˆæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œä½†åº”è¯¥è®¤ä¸ºæœ‰æ•°æ®ï¼ˆå¥–ç½šå®Œæˆåº¦ä¸º0ï¼‰
                            rewardPunishmentData.add(RewardPunishmentData(
                                period = displayPeriod,
                                rewardValue = 0f,
                                punishmentValue = 0f
                            ))
                        }
                    } else {
                        // å†å²æœˆï¼šä½¿ç”¨èšåˆè¡¨æ•°æ®
                        val monthRecord = rewardPunishmentMonthUserDao.getRecordByCategoryAndMonth(categoryId, month)
                        if (monthRecord != null && (monthRecord.totalRewardCount > 0 || monthRecord.totalPunishCount > 0)) {
                            val rewardCompletion = if (monthRecord.totalRewardCount > 0) {
                                (monthRecord.doneRewardCount.toFloat() / monthRecord.totalRewardCount * 100).coerceAtMost(100f)
                            } else 0f
                            val punishmentCompletion = if (monthRecord.totalPunishCount > 0) {
                                (monthRecord.donePunishCount.toFloat() / monthRecord.totalPunishCount * 100).coerceAtMost(100f)
                            } else 0f
                            
                            rewardPunishmentData.add(RewardPunishmentData(
                                period = displayPeriod,
                                rewardValue = rewardCompletion,
                                punishmentValue = punishmentCompletion
                            ))
                        } else {
                            // è¯¥æœˆæ²¡æœ‰æ•°æ®
                            rewardPunishmentData.add(RewardPunishmentData(
                                period = displayPeriod,
                                rewardValue = -1f,
                                punishmentValue = -1f
                            ))
                        }
                    }
                } catch (e: Exception) {
                    android.util.Log.e("HomeViewModel", "è·å–æœˆå¥–åŠ±æƒ©ç½šæ•°æ®å¤±è´¥: $e")
                    rewardPunishmentData.add(RewardPunishmentData(
                        period = displayPeriod,
                        rewardValue = -1f,
                        punishmentValue = -1f
                    ))
                }
                
                android.util.Log.d("HomeViewModel", "æœˆæ•°æ®: $displayPeriod, å®é™…å¤©æ•°=$actualDaysInMonth, ä½¿ç”¨æ—¶é—´=${usageRecord?.usageMinutes ?: 0}åˆ†é’Ÿ")
            }
            
            _usageLineData.value = usageData
            _completionLineData.value = completionData
            _rewardPunishmentData.value = rewardPunishmentData
            
            android.util.Log.d("HomeViewModel", "æœ€è¿‘15æœˆæ•°æ®åŠ è½½å®Œæˆ: usage=${usageData.size}æ¡, completion=${completionData.size}æ¡, reward=${rewardPunishmentData.size}æ¡")
            android.util.Log.d("HomeViewModel", "æœˆæ ‡ç­¾: ${usageData.map { it.period }}")
            
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "ä»èšåˆè¡¨åŠ è½½æœˆæ•°æ®å¤±è´¥ï¼Œå›é€€åˆ°åŸæœ‰é€»è¾‘", e)
            // å¦‚æœèšåˆè¡¨æŸ¥è¯¢å¤±è´¥ï¼Œå›é€€åˆ°åŸæœ‰çš„å®æ—¶è®¡ç®—é€»è¾‘
            loadLast15MonthsDataFallback(categoryId)
        }
    }
    
    /**
     * æœˆæ•°æ®åŠ è½½çš„å›é€€æ–¹æ³•ï¼ˆåŸæœ‰çš„å®æ—¶è®¡ç®—é€»è¾‘ï¼‰- ä¿®æ”¹ä¸ºä½¿ç”¨å®é™…å¤©æ•°
     */
    private suspend fun loadLast15MonthsDataFallback(categoryId: Int) {
        android.util.Log.d("HomeViewModel", "ä½¿ç”¨å›é€€æ–¹æ³•åŠ è½½æœˆæ•°æ®")
        
        val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
        val monthFormat = SimpleDateFormat("yyyy-MM", Locale.getDefault())
        val calendar = Calendar.getInstance()
        val today = Calendar.getInstance()
        val monthList = mutableListOf<String>()
        val periodList = mutableListOf<String>()
        
        // ç”Ÿæˆæœ€è¿‘15æœˆçš„æœˆä»½åˆ—è¡¨
        for (i in 14 downTo 0) {
            calendar.time = Date()
            calendar.add(Calendar.MONTH, -i)
            val month = monthFormat.format(calendar.time)
            monthList.add(month)
            
            // ç”Ÿæˆæ˜¾ç¤ºæ ‡ç­¾
            if (i == 0) {
                periodList.add("æœ¬æœˆ")
            } else {
                val parts = month.split("-")
                if (parts.size == 2) {
                    val year = parts[0].takeLast(2)
                    val monthNum = parts[1]
                    periodList.add("$year-$monthNum")
                } else {
                    periodList.add(month)
                }
            }
        }
        
        // å®æ—¶è®¡ç®—é€»è¾‘ï¼ˆä¿®æ”¹ä¸ºä½¿ç”¨å®é™…å¤©æ•°ï¼‰
        val usageData = mutableListOf<UsageData>()
        for (i in monthList.indices) {
            val month = monthList[i]
            calendar.time = monthFormat.parse(month + "-01")!!
            val monthStart = calendar.time
            calendar.add(Calendar.MONTH, 1)
            calendar.add(Calendar.DAY_OF_YEAR, -1)
            val monthEnd = calendar.time
            
            var monthlyTotalMinutes = 0
            var actualDaysWithData = 0
            
            calendar.time = monthStart
            while (calendar.time <= monthEnd && !calendar.time.after(today.time)) {
                val date = dateFormat.format(calendar.time)
                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                val dailyMinutes = (realUsage + virtualUsage) / 60
                
                monthlyTotalMinutes += dailyMinutes
                if (dailyMinutes > 0) {
                    actualDaysWithData++
                }
                
                calendar.add(Calendar.DAY_OF_YEAR, 1)
            }
            
            // ä½¿ç”¨å®é™…æœ‰æ•°æ®çš„å¤©æ•°è®¡ç®—å¹³å‡å€¼ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ™ä½¿ç”¨0
            val avgDailyMinutes = if (actualDaysWithData > 0) {
                monthlyTotalMinutes / actualDaysWithData
            } else {
                0
            }
            
            usageData.add(UsageData(
                period = periodList[i],
                usageMinutes = avgDailyMinutes,
                completionRate = 0f
            ))
            
            android.util.Log.d("HomeViewModel", "æœˆæ•°æ®å›é€€: ${periodList[i]}, æ€»æ—¶é•¿=${monthlyTotalMinutes}åˆ†é’Ÿ, æœ‰æ•°æ®å¤©æ•°=$actualDaysWithData, å¹³å‡æ¯æ—¥=${avgDailyMinutes}åˆ†é’Ÿ")
        }
        
        val completionData = mutableListOf<UsageData>()
        for (i in monthList.indices) {
            val month = monthList[i]
            calendar.time = monthFormat.parse(month + "-01")!!
            val monthStart = calendar.time
            calendar.add(Calendar.MONTH, 1)
            calendar.add(Calendar.DAY_OF_YEAR, -1)
            val monthEnd = calendar.time
            
            var totalCompletionRate = 0f
            var actualDaysWithData = 0
            
            calendar.time = monthStart
            while (calendar.time <= monthEnd && !calendar.time.after(today.time)) {
                val date = dateFormat.format(calendar.time)
                val dailyCompletionRate = calculateDailyGoalCompletionRate(categoryId, date)
                
                // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦æœ‰ä½¿ç”¨æ•°æ®
                val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
                val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
                
                if (realUsage > 0 || virtualUsage > 0) {
                    totalCompletionRate += dailyCompletionRate
                    actualDaysWithData++
                }
                
                calendar.add(Calendar.DAY_OF_YEAR, 1)
            }
            
            // ä½¿ç”¨å®é™…æœ‰æ•°æ®çš„å¤©æ•°è®¡ç®—å¹³å‡å®Œæˆç‡
            val avgCompletionRate = if (actualDaysWithData > 0) {
                totalCompletionRate / actualDaysWithData
            } else {
                0f
            }
            
            completionData.add(UsageData(
                period = periodList[i],
                usageMinutes = 0,
                completionRate = avgCompletionRate
            ))
        }
        
        _usageLineData.value = usageData
        _completionLineData.value = completionData
        _rewardPunishmentData.value = emptyList()
    }
    
    /**
     * è®¡ç®—æŸæ—¥çš„ç›®æ ‡å®Œæˆç‡
     */
    private suspend fun calculateDailyGoalCompletionRate(categoryId: Int, date: String): Float {
        return try {
            // è·å–è¯¥åˆ†ç±»çš„ç›®æ ‡æ—¶é—´ï¼ˆä»goals_reward_punishment_usersè¡¨ï¼‰
            val goal = goalRewardPunishmentUserDao.getUserGoalByCatId(categoryId)
            val goalMinutes = goal?.dailyGoalMin ?: 120 // é»˜è®¤2å°æ—¶
            
            // è·å–å®é™…ä½¿ç”¨æ—¶é—´
            val realUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 0) ?: 0
            val virtualUsage = dailyUsageDao.getTotalUsageByCategoryAndType(categoryId, date, 1) ?: 0
            val actualMinutes = (realUsage + virtualUsage) / 60
            
            // è®¡ç®—å®Œæˆç‡
            if (goalMinutes > 0) {
                (actualMinutes.toFloat() / goalMinutes * 100).coerceAtMost(100f)
            } else {
                0f
            }
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "è®¡ç®—ç›®æ ‡å®Œæˆç‡å¤±è´¥: $e")
            0f
        }
    }
    
    /**
     * ç”Ÿæˆæ—¥æœŸæ—¶é—´è½´ï¼šæ™ºèƒ½è°ƒæ•´æ—¶é—´è½´æ˜¾ç¤ºé€»è¾‘
     * - å¦‚æœæ²¡æœ‰å†å²æ•°æ®ï¼Œä»Šå¤©æ”¾åœ¨å·¦ä¾§ï¼Œæ˜¾ç¤ºä»Šå¤©+æœªæ¥14å¤©
     * - å¦‚æœæœ‰å†å²æ•°æ®ï¼Œä»Šå¤©æ”¾åœ¨å³ä¾§ï¼Œæ˜¾ç¤ºè¿‡å»14å¤©+ä»Šå¤©
     */
    private suspend fun generateDailyTimeAxis(): List<String> {
        val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())
        val calendar = Calendar.getInstance()
        val today = dateFormat.format(calendar.time)
        
        val timeAxis = mutableListOf<String>()
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å†å²æ•°æ®
        val hasHistoricalData = checkHasHistoricalData()
        
        if (hasHistoricalData) {
            // æœ‰å†å²æ•°æ®ï¼šä»Šå¤©åœ¨å³ä¾§ï¼Œæ˜¾ç¤ºè¿‡å»14å¤©+ä»Šå¤©
            calendar.time = dateFormat.parse(today)!!
            calendar.add(Calendar.DAY_OF_YEAR, -14)
            
            for (i in 0 until 15) {
                timeAxis.add(dateFormat.format(calendar.time))
                calendar.add(Calendar.DAY_OF_YEAR, 1)
            }
        } else {
            // æ²¡æœ‰å†å²æ•°æ®ï¼šä»Šå¤©åœ¨å·¦ä¾§ï¼Œæ˜¾ç¤ºä»Šå¤©+æœªæ¥14å¤©
            calendar.time = dateFormat.parse(today)!!
            
            for (i in 0 until 15) {
                timeAxis.add(dateFormat.format(calendar.time))
                calendar.add(Calendar.DAY_OF_YEAR, 1)
            }
        }
        
        return timeAxis
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦æœ‰å†å²æ•°æ®ï¼ˆä»Šå¤©ä¹‹å‰çš„æ•°æ®ï¼‰
     */
    private suspend fun checkHasHistoricalData(): Boolean {
        return try {
            val today = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault()).format(Date())
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ˜¨å¤©æˆ–æ›´æ—©çš„æ•°æ®
            val historicalData = summaryUsageDao.getDailyUsage(_selectedCategory.value?.id ?: 1, 30)
            historicalData.any { it.date < today }
        } catch (e: Exception) {
            android.util.Log.e("HomeViewModel", "æ£€æŸ¥å†å²æ•°æ®å¤±è´¥", e)
            false
        }
    }






} 